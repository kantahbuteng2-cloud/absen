<!DOCTYPE html>
<html lang="id">
<head>
  <!-- Meta Tags -->
  <base target="_top">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#1976d2">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Absensi Apel">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-TileColor" content="#1976d2">
  <meta name="application-name" content="Absensi Apel Lapas Baubau">
  
  <!-- Icons -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“…</text></svg>">
  
  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

  <style>
    /* ===== VARIABLES ===== */
    :root {
      --primary: #1976d2;
      --primary-dark: #0d47a1;
      --primary-light: #bbdefb;
      --success: #4caf50;
      --success-dark: #2e7d32;
      --warning: #ff9800;
      --warning-dark: #ef6c00;
      --danger: #f44336;
      --danger-dark: #c62828;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --gray-dark: #495057;
      --border-radius: 16px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --box-shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
      --transition: all 0.3s ease;
    }
    
    /* ===== RESET & BASE ===== */
    html {
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: transparent;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: rgba(25, 118, 210, 0.2);
    }
    
    body {
      font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: var(--dark);
      min-height: 100vh;
      line-height: 1.6;
      overflow-x: hidden;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    /* ===== LAYOUT ===== */
    .container {
      max-width: 100%;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 12px;
    }
    
    /* ===== HEADER ===== */
    .header {
      text-align: center;
      margin-bottom: 15px;
      padding: 20px 15px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      flex-shrink: 0;
      position: relative;
    }
    
    .header-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 18px;
      margin-bottom: 15px;
    }
    
    .header-logo i {
      font-size: 3.2rem;
      background: rgba(255, 255, 255, 0.25);
      padding: 22px;
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.3);
    }
    
    .header h1 {
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 1.9rem;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      line-height: 1.3;
    }
    
    .header p {
      font-size: 1.15rem;
      opacity: 0.95;
      font-weight: 400;
      margin-bottom: 8px;
    }
    
    #datetime {
      margin-top: 12px;
      font-size: 1.1rem;
      background: rgba(255, 255, 255, 0.15);
      padding: 8px 15px;
      border-radius: 50px;
      display: inline-block;
      font-weight: 500;
    }
    
    /* ===== BUTTONS ===== */
    .logout-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      font-size: 1.3rem;
      z-index: 100;
    }
    
    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      padding: 22px 20px;
      font-size: 1.2rem;
      font-weight: 700;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      width: 100%;
      font-family: 'Poppins', sans-serif;
      min-height: 65px;
      letter-spacing: 0.5px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    }
    
    .btn:active {
      transform: scale(0.97);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
    }
    
    .btn-primary {
      background: linear-gradient(to right, var(--primary), var(--primary-dark));
      color: white;
    }
    
    .btn-primary:hover {
      background: linear-gradient(to right, var(--primary-dark), var(--primary));
      box-shadow: 0 8px 25px rgba(25, 118, 210, 0.4);
    }
    
    .btn-warning {
      background: linear-gradient(to right, var(--warning), var(--warning-dark));
      color: white;
    }
    
    .btn-warning:hover {
      background: linear-gradient(to right, var(--warning-dark), var(--warning));
      box-shadow: 0 8px 25px rgba(255, 152, 0, 0.4);
    }
    
    .btn-success {
      background: linear-gradient(to right, var(--success), var(--success-dark));
      color: white;
    }
    
    .btn-success:hover {
      background: linear-gradient(to right, var(--success-dark), var(--success));
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
    }
    
    .btn-danger {
      background: linear-gradient(to right, var(--danger), var(--danger-dark));
      color: white;
    }
    
    .btn-danger:hover {
      background: linear-gradient(to right, var(--danger-dark), var(--danger));
      box-shadow: 0 8px 25px rgba(244, 67, 54, 0.4);
    }
    
    .btn i {
      font-size: 1.5rem;
    }
    
    /* ===== MAIN CONTENT ===== */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    /* ===== USER INFO ===== */
    .user-info {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      border-radius: var(--border-radius);
      padding: 22px 20px;
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
      border-left: 8px solid var(--primary);
      box-shadow: var(--box-shadow);
    }
    
    .user-avatar {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 2.2rem;
      flex-shrink: 0;
      border: 4px solid white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .user-details h3 {
      font-size: 1.5rem;
      margin-bottom: 8px;
      color: var(--primary-dark);
      font-weight: 700;
      line-height: 1.2;
    }
    
    .user-details p {
      font-size: 1.15rem;
      color: var(--gray);
      margin-bottom: 6px;
      font-weight: 500;
    }
    
    /* ===== STATUS BAR ===== */
    .status-bar {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      background: white;
      border-radius: var(--border-radius);
      padding: 22px 20px;
      margin-bottom: 20px;
      box-shadow: var(--box-shadow);
      border: 2px solid var(--primary-light);
    }
    
    .status-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 10px 5px;
    }
    
    .status-icon {
      font-size: 2.5rem;
      margin-bottom: 12px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(25, 118, 210, 0.1);
    }
    
    .status-label {
      font-size: 1rem;
      color: var(--gray);
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .status-value {
      font-size: 1.3rem;
      font-weight: 800;
      color: var(--dark);
    }
    
    /* ===== SCANNER CONTAINER ===== */
    .scanner-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-bottom: 20px;
      min-height: 60vh;
    }
    
    .scanner-card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow-lg);
      overflow: hidden;
      flex: 1;
      display: flex;
      flex-direction: column;
      border: 2px solid var(--primary-light);
      position: relative;
    }
    
    .card-header {
      background: var(--primary-light);
      color: var(--primary-dark);
      padding: 22px 20px;
      font-weight: 700;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 15px;
      flex-shrink: 0;
      border-bottom: 3px solid var(--primary);
    }
    
    .card-header i {
      font-size: 1.8rem;
    }
    
    .card-body {
      padding: 0;
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    /* ===== QR SCANNER AREA ===== */
    .scanner-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
      min-height: 450px;
      width: 100%;
      background: #000;
    }
    
    #reader {
      width: 100% !important;
      height: 100% !important;
      flex: 1;
      min-height: 450px;
      background: #000;
      position: relative;
    }
    
    #reader video {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
    }
    
    #reader__scan_region {
      width: 100% !important;
      height: 100% !important;
      background: transparent !important;
      display: flex !important;
      align-items: center;
      justify-content: center;
    }
    
    /* ===== SCANNER INSTRUCTIONS ===== */
    .scanner-instructions {
      text-align: center;
      padding: 25px 20px;
      background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
      color: white;
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      flex-shrink: 0;
      margin-top: auto;
      z-index: 5;
    }
    
    .scanner-instructions p {
      margin-bottom: 12px;
      color: white;
      font-size: 1.2rem;
      font-weight: 500;
    }
    
    .scanner-instructions .highlight {
      color: #4CAF50;
      font-weight: 700;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .instruction-icons {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }
    
    .instruction-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      flex: 1;
    }
    
    .instruction-icon i {
      font-size: 2.2rem;
      color: #4CAF50;
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 50%;
      width: 70px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .instruction-icon span {
      font-size: 1.05rem;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 500;
    }
    
    /* ===== ACTION BUTTONS ===== */
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 20px;
      flex-shrink: 0;
    }
    
    /* ===== LOADING SCREEN ===== */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
      flex: 1;
      background: white;
      border-radius: var(--border-radius);
    }
    
    .spinner {
      width: 80px;
      height: 80px;
      border: 8px solid var(--primary-light);
      border-top: 8px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 30px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading p {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 10px;
    }
    
    .loading .text-muted {
      font-size: 1.1rem;
      color: var(--gray);
    }
    
    /* ===== REGISTRATION SCREEN ===== */
    .registration-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .form-group {
      margin-bottom: 30px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 15px;
      font-weight: 600;
      color: var(--dark);
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .input-with-icon {
      position: relative;
    }
    
    .input-icon {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
      font-size: 1.5rem;
      z-index: 2;
    }
    
    input {
      width: 100%;
      padding: 22px 20px 22px 65px;
      border: 3px solid var(--gray-light);
      border-radius: 12px;
      font-size: 1.3rem;
      font-family: inherit;
      transition: var(--transition);
      background: white;
      font-weight: 500;
    }
    
    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 5px rgba(25, 118, 210, 0.2);
    }
    
    .form-group small {
      display: block;
      margin-top: 10px;
      font-size: 1.05rem;
      color: var(--gray);
      padding-left: 5px;
    }
    
    /* ===== FOOTER ===== */
    .footer {
      text-align: center;
      padding: 25px 20px;
      color: var(--gray);
      font-size: 1.1rem;
      margin-top: 25px;
      border-top: 2px solid var(--gray-light);
      flex-shrink: 0;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }
    
    .footer p {
      margin-bottom: 12px;
      font-weight: 500;
    }
    
    /* ===== BADGES & MESSAGES ===== */
    .sisa-kesempatan-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      background: var(--success);
      color: white;
      padding: 10px 18px;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: 700;
      z-index: 10;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      border: 2px solid white;
    }
    
    .scanner-message {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 12px;
      z-index: 10;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border-left: 5px solid var(--success);
    }
    
    /* ===== COOKIE BANNER ===== */
    .cookie-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 20px;
      z-index: 1000;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }
    
    .cookie-content {
      flex: 1;
    }
    
    .cookie-content p {
      margin: 0;
      font-size: 1.05rem;
    }
    
    .cookie-buttons {
      display: flex;
      gap: 10px;
      flex-shrink: 0;
    }
    
    .cookie-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      min-width: 100px;
    }
    
    .cookie-btn-accept {
      background: white;
      color: var(--primary);
    }
    
    .cookie-btn-decline {
      background: transparent;
      color: white;
      border: 2px solid white;
    }
    
    /* ===== RESPONSIVE DESIGN ===== */
    @media (max-width: 768px) {
      html { font-size: 17px; }
      .container { padding: 10px; }
      .header { padding: 18px 15px; }
      .header h1 { font-size: 1.7rem; }
      .header-logo i { font-size: 2.8rem; padding: 20px; }
      .action-buttons { grid-template-columns: 1fr; gap: 15px; }
      .btn { padding: 20px 18px; font-size: 1.15rem; }
      .logout-btn { width: 45px; height: 45px; font-size: 1.2rem; }
    }
    
    @media (max-width: 480px) {
      html { font-size: 18px; }
      .container { padding: 8px; }
      .header h1 { font-size: 1.6rem; }
      .header p { font-size: 1.1rem; }
      .user-info {
        flex-direction: column;
        text-align: center;
        gap: 15px;
        padding: 20px 15px;
      }
      .user-avatar { width: 70px; height: 70px; font-size: 2rem; }
      .user-details h3 { font-size: 1.4rem; }
      .status-bar { grid-template-columns: 1fr; gap: 20px; }
      .status-item {
        flex-direction: row;
        text-align: left;
        gap: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 12px;
      }
      .status-icon {
        margin-bottom: 0;
        width: 50px;
        height: 50px;
        font-size: 2rem;
        flex-shrink: 0;
      }
      .status-content { flex: 1; }
      .scanner-area { min-height: 400px; }
      .scanner-instructions { padding: 20px 15px; }
      .scanner-instructions p { font-size: 1.1rem; }
      .instruction-icons { flex-direction: column; gap: 20px; }
      .instruction-icon {
        flex-direction: row;
        justify-content: flex-start;
        gap: 15px;
      }
      .instruction-icon i {
        width: 60px; height: 60px; font-size: 1.8rem; flex-shrink: 0;
      }
      .instruction-icon span { font-size: 1rem; }
    }
    
    @media (max-width: 360px) {
      .header h1 { font-size: 1.4rem; }
      .header p { font-size: 1rem; }
      .btn { font-size: 1.1rem; padding: 18px 15px; min-height: 60px; }
      .btn i { font-size: 1.4rem; }
      .card-header { font-size: 1.2rem; padding: 20px 15px; }
    }
    
    @media (orientation: landscape) and (max-height: 600px) {
      .scanner-container { min-height: 70vh; }
      .header { padding: 15px 12px; margin-bottom: 10px; }
      .header h1 { font-size: 1.4rem; }
      .header p { font-size: 1rem; }
      .header-logo i { font-size: 2rem; padding: 15px; }
      .user-info { margin-bottom: 10px; padding: 15px; }
      .status-bar { padding: 15px; margin-bottom: 10px; }
      .btn { padding: 18px 15px; min-height: 55px; font-size: 1.1rem; }
      .scanner-instructions { padding: 15px; }
      .scanner-instructions p { font-size: 1rem; }
      .instruction-icon i { font-size: 1.5rem; width: 50px; height: 50px; }
    }
    
    @media (orientation: landscape) and (max-height: 500px) {
      .scanner-area { min-height: 55vh; }
      .header { padding: 10px; margin-bottom: 8px; }
      .header h1 { font-size: 1.2rem; }
      .action-buttons { margin-top: 10px; }
      .btn { padding: 15px; min-height: 55px; font-size: 1rem; }
    }
    
    /* ===== DARK MODE ===== */
    @media (prefers-color-scheme: dark) {
      :root {
        --light: #2d3748;
        --dark: #f7fafc;
        --gray-light: #4a5568;
        --gray-dark: #cbd5e0;
      }
      
      body {
        background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
        color: var(--dark);
      }
      
      .scanner-card, .status-bar, .user-info {
        background: #2d3748;
        color: var(--dark);
      }
      
      input {
        background: #4a5568;
        color: white;
        border-color: #718096;
      }
      
      .footer {
        background: #2d3748;
        color: #cbd5e0;
      }
      
      .scanner-message {
        background: #4a5568;
        color: white;
      }
    }
    
    /* ===== UTILITY CLASSES ===== */
    .text-center { text-align: center; }
    .text-muted { color: var(--gray); }
    .mt-1 { margin-top: 15px; }
    .mt-2 { margin-top: 25px; }
    .mb-1 { margin-bottom: 15px; }
    .mb-2 { margin-bottom: 25px; }
    .d-none { display: none !important; }
    .d-flex { display: flex; }
    .d-block { display: block; }
    .d-grid { display: grid; }
    .highlight { color: var(--primary-dark); font-weight: 700; }
    .fw-bold { font-weight: 700; }
    .text-success { color: var(--success); }
    .text-warning { color: var(--warning); }
    .text-danger { color: var(--danger); }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <button id="logoutBtn" class="logout-btn d-none" title="Logout">
        <i class="fas fa-sign-out-alt"></i>
      </button>
      <div class="header-logo">
        <i class="fas fa-calendar-check"></i>
      </div>
      <h1>ABSENSI APEL LAPAS BAUBAU</h1>
      <p>Scan QR Code untuk absensi apel pagi/sore</p>
      <div id="datetime" class="mt-1"></div>
    </header>
    
    <!-- Main Content -->
    <main class="main-content" id="mainContent">
      <!-- Loading Screen -->
      <div id="loadingScreen" class="loading">
        <div class="spinner"></div>
        <p id="loadingText">Memuat sistem scanner...</p>
        <p class="text-muted">Harap tunggu sebentar</p>
      </div>
      
      <!-- Scanner Screen -->
      <div id="scannerScreen" class="scanner-container d-none">
        <!-- User Info -->
        <div id="userInfoCard" class="user-info d-none">
          <div class="user-avatar">
            <i class="fas fa-user-tie"></i>
          </div>
          <div class="user-details">
            <h3 id="userName">Nama Pegawai</h3>
            <p>NIP: <span id="userNip">-</span></p>
            <p id="userStatus">Status: <span class="highlight">Belum terdaftar</span></p>
          </div>
        </div>
        
        <!-- Status Bar -->
        <div class="status-bar">
          <div class="status-item">
            <div class="status-icon" style="color: var(--primary);">
              <i class="fas fa-clock"></i>
            </div>
            <div class="status-content">
              <div class="status-label">WAKTU</div>
              <div class="status-value" id="currentTime">--:--</div>
            </div>
          </div>
          
          <div class="status-item">
            <div class="status-icon" style="color: var(--success);">
              <i class="fas fa-calendar-day"></i>
            </div>
            <div class="status-content">
              <div class="status-label">TANGGAL</div>
              <div class="status-value" id="currentDate">-- --- ----</div>
            </div>
          </div>
          
          <div class="status-item">
            <div class="status-icon" style="color: var(--warning);">
              <i class="fas fa-map-marker-alt"></i>
            </div>
            <div class="status-content">
              <div class="status-label">LOKASI</div>
              <div class="status-value" id="locationStatus">--</div>
            </div>
          </div>
        </div>
        
        <!-- Scanner Card -->
        <div class="scanner-card">
          <!-- Badge Sisa Kesempatan -->
          <div id="sisaKesempatanBadge" class="sisa-kesempatan-badge d-none">
            Sisa: <span id="sisaKesempatanCount">2</span>/2
          </div>
          
          <!-- Scanner Message -->
          <div id="scannerMessage" class="scanner-message d-none"></div>
          
          <div class="card-header">
            <i class="fas fa-qrcode"></i>
            SCAN QR CODE APEL
          </div>
          <div class="card-body">
            <div class="scanner-area">
              <div id="reader"></div>
            </div>
            
            <div class="scanner-instructions">
              <p class="highlight">
                <i class="fas fa-info-circle"></i> 
                ARAHKAN KAMERA KE QR CODE APEL
              </p>
              <p>Posisikan QR Code dalam area kamera</p>
              
              <div class="instruction-icons">
                <div class="instruction-icon">
                  <i class="fas fa-qrcode"></i>
                  <span>Scan QR Code</span>
                </div>
                <div class="instruction-icon">
                  <i class="fas fa-lightbulb"></i>
                  <span>Cahaya Cukup</span>
                </div>
                <div class="instruction-icon">
                  <i class="fas fa-hand-steady"></i>
                  <span>Tangan Stabil</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
          <button id="registerBtn" class="btn btn-warning">
            <i class="fas fa-user-plus"></i> 
            <span>DAFTAR AKUN BARU</span>
          </button>
          <button id="refreshBtn" class="btn btn-success">
            <i class="fas fa-redo-alt"></i> 
            <span>REFRESH SCANNER</span>
          </button>
        </div>
      </div>
      
      <!-- Registration Screen -->
      <div id="registerScreen" class="registration-screen d-none">
        <div class="scanner-card">
          <div class="card-header">
            <i class="fas fa-user-plus"></i> 
            PENDAFTARAN AKUN BARU
          </div>
          <div class="card-body" style="padding: 25px 20px;">
            <div class="user-info mb-2" style="background: #e8f5e9; border-color: #4CAF50;">
              <div class="user-avatar" style="background: #4CAF50;">
                <i class="fas fa-user-edit"></i>
              </div>
              <div class="user-details">
                <h3 style="color: #2e7d32;">Pendaftaran Pegawai</h3>
                <p class="text-muted">Masukkan NIP Anda untuk mendaftar</p>
              </div>
            </div>
            
            <div class="form-group">
              <label for="regNip">
                <i class="fas fa-id-card"></i> 
                NIP PEGAWAI
              </label>
              <div class="input-with-icon">
                <i class="input-icon fas fa-id-card"></i>
                <input type="text" id="regNip" placeholder="Contoh: 197001012000011001" maxlength="20" inputmode="numeric">
              </div>
              <small>Masukkan NIP sesuai yang terdaftar di Lapas Baubau (hanya angka)</small>
            </div>
            
            <div class="form-group">
              <label>
                <i class="fas fa-info-circle"></i> 
                INFORMASI PERANGKAT
              </label>
              <div class="input-with-icon">
                <i class="input-icon fas fa-mobile-alt"></i>
                <input type="text" id="regDeviceId" readonly style="background: #f8f9fa; color: #666;">
              </div>
              <small>ID unik perangkat Anda untuk keamanan</small>
            </div>
            
            <div class="action-buttons" style="grid-template-columns: 1fr; gap: 20px; margin-top: 30px;">
              <button id="submitRegisterBtn" class="btn btn-success">
                <i class="fas fa-check-circle"></i> 
                DAFTARKAN AKUN
              </button>
              <button id="backToScannerBtn" class="btn btn-primary">
                <i class="fas fa-arrow-left"></i> 
                KEMBALI KE SCANNER
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
    
    <!-- Footer -->
    <footer class="footer">
      <p>Â© 2023 Lapas Baubau | Sistem Absensi Apel Digital</p>
      <p>Untuk bantuan, hubungi admin di ruang IT</p>
      <p style="font-size: 1rem; margin-top: 10px;">
        <i class="fas fa-mobile-alt"></i> 
        Versi Mobile | Data tersimpan di perangkat
      </p>
    </footer>
  </div>

  <!-- Cookie Consent Banner -->
  <div id="cookieBanner" class="cookie-banner d-none">
    <div class="cookie-content">
      <p>
        <i class="fas fa-cookie-bite"></i> 
        Sistem ini menggunakan penyimpanan lokal perangkat untuk menyimpan data login Anda. 
        Data hanya disimpan di perangkat Anda dan tidak dikirim ke server lain.
      </p>
    </div>
    <div class="cookie-buttons">
      <button id="cookieAccept" class="cookie-btn cookie-btn-accept">Terima</button>
      <button id="cookieDecline" class="cookie-btn cookie-btn-decline">Tolak</button>
    </div>
  </div>

  <script>
    // ============================================
    // GLOBAL CONFIGURATION
    // ============================================
    const CONFIG = {
      GAS_WEB_APP_URL: 'https://script.google.com/macros/s/AKfycbxVImFhvgRI8nfJH5_uQb0ZhwNmy7jlup0sbmTQ5JldZeBWz7Fw2pq3r1bU9WtiBJ3H/exec',
      APP_NAME: 'Absensi Apel Lapas Baubau',
      VERSION: '1.0.0',
      MAX_NIP_LENGTH: 20,
      MIN_NIP_LENGTH: 8,
      MAX_ATTEMPTS: 2,
      LOCATION_TIMEOUT: 15000,
      SCANNER_FPS: 20
    };
    
    // ============================================
    // GLOBAL VARIABLES
    // ============================================
    let userData = null;
    let html5QrCode = null;
    let currentApelType = null;
    let isScannerRunning = false;
    let isAutoLoginAttempted = false;
    let deviceId = null;
    let deferredPrompt = null;
    
    // ============================================
    // DOM ELEMENTS
    // ============================================
    const loadingScreen = document.getElementById('loadingScreen');
    const scannerScreen = document.getElementById('scannerScreen');
    const registerScreen = document.getElementById('registerScreen');
    const userInfoCard = document.getElementById('userInfoCard');
    const userName = document.getElementById('userName');
    const userNip = document.getElementById('userNip');
    const userStatus = document.getElementById('userStatus');
    const currentTime = document.getElementById('currentTime');
    const currentDate = document.getElementById('currentDate');
    const locationStatus = document.getElementById('locationStatus');
    const datetimeElement = document.getElementById('datetime');
    const registerBtn = document.getElementById('registerBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const regNip = document.getElementById('regNip');
    const regDeviceId = document.getElementById('regDeviceId');
    const submitRegisterBtn = document.getElementById('submitRegisterBtn');
    const backToScannerBtn = document.getElementById('backToScannerBtn');
    const sisaKesempatanBadge = document.getElementById('sisaKesempatanBadge');
    const sisaKesempatanCount = document.getElementById('sisaKesempatanCount');
    const scannerMessage = document.getElementById('scannerMessage');
    const logoutBtn = document.getElementById('logoutBtn');
    const loadingText = document.getElementById('loadingText');
    const cookieBanner = document.getElementById('cookieBanner');
    const cookieAccept = document.getElementById('cookieAccept');
    const cookieDecline = document.getElementById('cookieDecline');
    
    // ============================================
    // STORAGE KEYS
    // ============================================
    const STORAGE_KEYS = {
      USER_DATA: 'absensi_apel_user_data',
      DEVICE_ID: 'absensi_apel_device_id',
      COOKIE_CONSENT: 'absensi_apel_cookie_consent',
      LAST_LOGIN: 'absensi_apel_last_login',
      APP_SETTINGS: 'absensi_apel_settings',
      PWA_PROMPT_SHOWN: 'absensi_apel_pwa_prompt'
    };
    
    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
      console.log(`${CONFIG.APP_NAME} v${CONFIG.VERSION} - Initializing...`);
      
      // Check for required browser features
      if (!checkBrowserSupport()) {
        return;
      }
      
      // Initialize UI
      adjustForMobile();
      generateDeviceId();
      updateDateTime();
      setInterval(updateDateTime, 1000);
      checkLocationStatus();
      
      // Check cookie consent first
      checkCookieConsent();
      
      // Event listeners
      setupEventListeners();
      
      // Handle online/offline status
      setupNetworkListeners();
      
      // Handle PWA installation
      setupPWAListeners();
      
      // Handle visibility changes
      document.addEventListener('visibilitychange', handleVisibilityChange);
    });
    
    // ============================================
    // BROWSER SUPPORT CHECK
    // ============================================
    function checkBrowserSupport() {
      const requiredFeatures = [
        'localStorage',
        'navigator.mediaDevices',
        'navigator.geolocation',
        'Promise',
        'fetch'
      ];
      
      const missingFeatures = requiredFeatures.filter(feature => {
        if (feature === 'localStorage') return !window.localStorage;
        if (feature === 'navigator.mediaDevices') return !navigator.mediaDevices;
        if (feature === 'navigator.geolocation') return !navigator.geolocation;
        if (feature === 'Promise') return !window.Promise;
        if (feature === 'fetch') return !window.fetch;
        return false;
      });
      
      if (missingFeatures.length > 0) {
        Swal.fire({
          icon: 'error',
          title: 'Browser Tidak Didukung',
          html: `Browser Anda tidak mendukung fitur berikut:<br>
                 <strong>${missingFeatures.join(', ')}</strong><br><br>
                 Gunakan browser modern seperti Chrome, Firefox, atau Safari versi terbaru.`,
          confirmButtonText: 'OK',
          confirmButtonColor: '#1976d2',
          allowOutsideClick: false
        });
        return false;
      }
      
      return true;
    }
    
    // ============================================
    // SETUP EVENT LISTENERS
    // ============================================
    function setupEventListeners() {
      // Button events
      registerBtn.addEventListener('click', showRegistrationScreen);
      refreshBtn.addEventListener('click', refreshScanner);
      submitRegisterBtn.addEventListener('click', submitRegistration);
      backToScannerBtn.addEventListener('click', showScannerScreen);
      logoutBtn.addEventListener('click', logoutUser);
      cookieAccept.addEventListener('click', acceptCookies);
      cookieDecline.addEventListener('click', declineCookies);
      
      // Input events
      regNip.addEventListener('input', function(e) {
        this.value = this.value.replace(/\D/g, '');
      });
      
      regNip.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          submitRegistration();
        }
      });
      
      // Handle back button
      window.addEventListener('popstate', function(e) {
        if (!registerScreen.classList.contains('d-none')) {
          showScannerScreen();
          e.preventDefault();
        }
      });
    }
    
    // ============================================
    // NETWORK HANDLING
    // ============================================
    function setupNetworkListeners() {
      window.addEventListener('online', function() {
        showToast('success', 'Koneksi Dipulihkan', 'Anda kembali terhubung ke internet');
        if (userData && userData.nip) {
          updateStatusAbsensi();
        }
      });
      
      window.addEventListener('offline', function() {
        showToast('warning', 'Koneksi Terputus', 'Periksa koneksi internet Anda');
      });
    }
    
    // ============================================
    // PWA HANDLING
    // ============================================
    function setupPWAListeners() {
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        // Show install prompt after delay
        setTimeout(() => {
          if (deferredPrompt && !localStorage.getItem(STORAGE_KEYS.PWA_PROMPT_SHOWN)) {
            showPWAInstallPrompt();
          }
        }, 5000);
      });
      
      window.addEventListener('appinstalled', () => {
        console.log('PWA installed successfully');
        localStorage.setItem(STORAGE_KEYS.PWA_PROMPT_SHOWN, 'true');
        deferredPrompt = null;
        showToast('success', 'Aplikasi Terpasang', 'Absensi Apel siap digunakan dari home screen');
      });
    }
    
    function showPWAInstallPrompt() {
      Swal.fire({
        title: 'Pasang Aplikasi',
        html: `<div style="text-align: center;">
                 <div style="font-size: 3.5rem; color: #1976d2; margin-bottom: 15px;">
                   <i class="fas fa-mobile-alt"></i>
                 </div>
                 <p style="font-size: 1.2rem;">Pasang aplikasi Absensi Apel ke home screen untuk akses lebih mudah?</p>
                 <small style="font-size: 1rem;">Aplikasi dapat digunakan seperti aplikasi native tanpa perlu membuka browser.</small>
               </div>`,
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'Pasang Sekarang',
        confirmButtonColor: '#1976d2',
        cancelButtonText: 'Nanti Saja',
        width: isMobileDevice() ? '90%' : '400px',
        background: '#f8f9fa'
      }).then((result) => {
        if (result.isConfirmed && deferredPrompt) {
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then((choiceResult) => {
            localStorage.setItem(STORAGE_KEYS.PWA_PROMPT_SHOWN, 'true');
            if (choiceResult.outcome === 'accepted') {
              console.log('User installed the PWA');
            }
            deferredPrompt = null;
          });
        } else {
          localStorage.setItem(STORAGE_KEYS.PWA_PROMPT_SHOWN, 'true');
        }
      });
    }
    
    // ============================================
    // COOKIE CONSENT
    // ============================================
    function checkCookieConsent() {
      const consent = localStorage.getItem(STORAGE_KEYS.COOKIE_CONSENT);
      
      if (consent === null) {
        // First time user, show cookie banner
        setTimeout(() => {
          cookieBanner.classList.remove('d-none');
        }, 1500);
      } else if (consent === 'accepted') {
        initializeApp();
      } else {
        showCookieWarning();
        setTimeout(initializeScanner, 1000);
      }
    }
    
    function acceptCookies() {
      localStorage.setItem(STORAGE_KEYS.COOKIE_CONSENT, 'accepted');
      cookieBanner.classList.add('d-none');
      showToast('success', 'Cookies Diterima', 'Data login akan disimpan di perangkat Anda');
      initializeApp();
    }
    
    function declineCookies() {
      localStorage.setItem(STORAGE_KEYS.COOKIE_CONSENT, 'declined');
      cookieBanner.classList.add('d-none');
      Swal.fire({
        icon: 'info',
        title: 'Cookies Ditolak',
        html: 'Anda perlu mendaftar setiap kali membuka aplikasi.<br><br>Data tidak akan disimpan di perangkat.',
        timer: 3000,
        showConfirmButton: false,
        toast: true,
        position: 'top'
      });
      initializeScanner();
    }
    
    function showCookieWarning() {
      showToast('warning', 'Cookies Dinonaktifkan', 'Data login tidak akan disimpan di perangkat Anda');
    }
    
    // ============================================
    // APP INITIALIZATION
    // ============================================
    function initializeApp() {
      loadingText.textContent = 'Memeriksa data login tersimpan...';
      
      // Try to load user data from localStorage
      setTimeout(() => {
        loadUserData();
        
        if (userData && userData.nip && userData.deviceId) {
          validateStoredUserData();
        } else {
          loadingText.textContent = 'Menyiapkan scanner...';
          setTimeout(initializeScanner, 500);
        }
      }, 1000);
    }
    
    function initializeScanner() {
      loadingText.textContent = 'Menyiapkan scanner QR Code...';
      
      if (typeof Html5Qrcode === 'undefined') {
        Swal.fire({
          icon: 'error',
          title: 'Library Tidak Ditemukan',
          html: 'Library QR Scanner gagal dimuat.<br><br>Periksa koneksi internet Anda.',
          confirmButtonText: 'OK',
          confirmButtonColor: '#1976d2'
        });
        return;
      }
      
      try {
        html5QrCode = new Html5Qrcode("reader");
        console.log("Scanner initialized successfully");
      } catch (e) {
        console.error("Failed to initialize scanner:", e);
        Swal.fire({
          icon: 'error',
          title: 'Gagal Inisialisasi Scanner',
          text: 'Terjadi kesalahan saat memulai scanner QR Code',
          confirmButtonText: 'OK',
          confirmButtonColor: '#1976d2'
        });
        return;
      }
      
      showScannerScreen();
    }
    
    // ============================================
    // USER DATA MANAGEMENT
    // ============================================
    function loadUserData() {
      try {
        const storedData = localStorage.getItem(STORAGE_KEYS.USER_DATA);
        if (storedData) {
          userData = JSON.parse(storedData);
          
          // Check if data is still valid (not too old)
          const lastLogin = localStorage.getItem(STORAGE_KEYS.LAST_LOGIN);
          if (lastLogin) {
            const lastLoginDate = new Date(lastLogin);
            const now = new Date();
            const daysDiff = (now - lastLoginDate) / (1000 * 60 * 60 * 24);
            
            // Clear data if older than 30 days
            if (daysDiff > 30) {
              clearInvalidUserData();
              return;
            }
          }
          
          console.log('Loaded user data:', userData);
        }
      } catch (e) {
        console.error("Error loading user data:", e);
        clearInvalidUserData();
      }
    }
    
    function saveUserData() {
      if (!userData) return;
      
      try {
        localStorage.setItem(STORAGE_KEYS.USER_DATA, JSON.stringify(userData));
        localStorage.setItem(STORAGE_KEYS.LAST_LOGIN, new Date().toISOString());
        console.log('User data saved to localStorage');
      } catch (e) {
        console.error("Error saving user data:", e);
      }
    }
    
    function clearInvalidUserData() {
      userData = null;
      localStorage.removeItem(STORAGE_KEYS.USER_DATA);
      localStorage.removeItem(STORAGE_KEYS.LAST_LOGIN);
      logoutBtn.classList.add('d-none');
    }
    
    // ============================================
    // USER VALIDATION
    // ============================================
    function validateStoredUserData() {
      if (isAutoLoginAttempted) return;
      
      isAutoLoginAttempted = true;
      loadingText.textContent = 'Memvalidasi data login...';
      
      callGASFunction('checkRegistrationStatus', { deviceId: deviceId })
        .then(response => {
          if (response.status === "registered") {
            autoLoginSuccess(response);
          } else {
            clearInvalidUserData();
            initializeScanner();
          }
        })
        .catch(error => {
          console.error("Validation failed:", error);
          if (userData && userData.nip) {
            updateUserInfo();
            initializeScanner();
          } else {
            clearInvalidUserData();
            initializeScanner();
          }
        });
    }
    
    function autoLoginSuccess(result) {
      userData = {
        nip: result.nip,
        nama: result.nama,
        deviceId: result.deviceId,
        jabatan: result.jabatan || ""
      };
      
      saveUserData();
      updateUserInfo();
      
      showToast('success', 'Login Otomatis Berhasil!', `Selamat datang kembali ${result.nama}`)
        .then(() => {
          initializeScanner();
        });
    }
    
    // ============================================
    // UI UPDATES
    // ============================================
    function updateUserInfo() {
      if (userData && userData.nip && userData.nama) {
        userName.textContent = userData.nama;
        userNip.textContent = userData.nip;
        
        if (userData.jabatan) {
          userStatus.innerHTML = `Jabatan: <span class="highlight">${userData.jabatan}</span> | Status: <span class="highlight" style="color: #4CAF50;">Terdaftar</span>`;
        } else {
          userStatus.innerHTML = 'Status: <span class="highlight" style="color: #4CAF50;">Terdaftar</span>';
        }
        
        userInfoCard.classList.remove('d-none');
        logoutBtn.classList.remove('d-none');
        updateStatusAbsensi();
      } else {
        userName.textContent = "Nama Pegawai";
        userNip.textContent = "-";
        userStatus.innerHTML = 'Status: <span class="highlight" style="color: #FF9800;">Belum terdaftar</span>';
        userInfoCard.classList.add('d-none');
        logoutBtn.classList.add('d-none');
        sisaKesempatanBadge.classList.add('d-none');
        scannerMessage.classList.add('d-none');
      }
    }
    
    function updateDateTime() {
      const now = new Date();
      const dateStr = now.toLocaleDateString('id-ID', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      const timeStr = now.toLocaleTimeString('id-ID', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      
      datetimeElement.textContent = `${dateStr} | ${timeStr}`;
      currentTime.textContent = now.toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'});
      currentDate.textContent = now.toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'});
    }
    
    function checkLocationStatus() {
      if (navigator.geolocation) {
        locationStatus.textContent = "Aktif";
        locationStatus.style.color = "var(--success)";
        locationStatus.style.fontWeight = "700";
      } else {
        locationStatus.textContent = "Nonaktif";
        locationStatus.style.color = "var(--danger)";
        locationStatus.style.fontWeight = "700";
      }
    }
    
    // ============================================
    // SCREEN NAVIGATION
    // ============================================
    function showScannerScreen() {
      loadingScreen.classList.add('d-none');
      registerScreen.classList.add('d-none');
      scannerScreen.classList.remove('d-none');
      
      history.pushState({ screen: 'scanner' }, '', '#scanner');
      
      setTimeout(() => {
        if (!isScannerRunning) {
          startScanner();
        }
      }, 500);
    }
    
    function showRegistrationScreen() {
      scannerScreen.classList.add('d-none');
      registerScreen.classList.remove('d-none');
      
      history.pushState({ screen: 'register' }, '', '#register');
      stopScanner();
      
      setTimeout(() => {
        regNip.focus();
      }, 300);
    }
    
    // ============================================
    // SCANNER FUNCTIONS
    // ============================================
    function startScanner() {
      if (!html5QrCode) return;
      
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        Swal.fire({
          icon: 'error',
          title: 'Kamera Tidak Didukung',
          html: 'Browser Anda tidak mendukung akses kamera.<br><br>Gunakan browser modern seperti Chrome, Firefox, atau Safari.',
          confirmButtonText: 'OK',
          confirmButtonColor: '#1976d2'
        });
        return;
      }
      
      Html5Qrcode.getCameras().then(devices => {
        if (!devices || devices.length === 0) {
          Swal.fire({
            icon: 'warning',
            title: 'Kamera Tidak Ditemukan',
            html: 'Tidak ada kamera yang terdeteksi pada perangkat Anda.<br><br>Pastikan kamera tersedia dan tidak sedang digunakan aplikasi lain.',
            confirmButtonText: 'OK',
            confirmButtonColor: '#1976d2'
          });
          return;
        }
        
        let cameraId = devices[0].id;
        const backCamera = devices.find(device => {
          const label = device.label.toLowerCase();
          return label.includes('back') || label.includes('rear') || label.includes('belakang');
        });
        
        if (backCamera) {
          cameraId = backCamera.id;
        }
        
        const qrboxSize = Math.min(window.innerWidth * 0.9, 750);
        
        html5QrCode.start(
          cameraId,
          {
            fps: CONFIG.SCANNER_FPS,
            qrbox: { width: qrboxSize, height: qrboxSize },
            aspectRatio: 1.0,
            disableFlip: false,
            focusMode: "continuous",
            experimentalFeatures: {
              useBarCodeDetectorIfSupported: true
            },
            showTorchButtonIfSupported: true,
            showZoomSliderIfSupported: true
          },
          onScanSuccess,
          onScanError
        ).then(() => {
          isScannerRunning = true;
          console.log("Scanner started successfully");
          loadingScreen.classList.add('d-none');
        }).catch(err => {
          console.error("Failed to start scanner:", err);
          handleCameraError(err);
        });
      }).catch(err => {
        console.error("Error getting cameras:", err);
        Swal.fire({
          icon: 'error',
          title: 'Akses Kamera Ditolak',
          html: `Izinkan akses kamera di pengaturan browser untuk menggunakan scanner.<br><br>
                 <small>Klik ikon gembok/kamera di address bar browser untuk mengatur izin.</small>`,
          confirmButtonText: 'OK',
          confirmButtonColor: '#1976d2'
        });
      });
    }
    
    function stopScanner() {
      if (html5QrCode && isScannerRunning) {
        try {
          html5QrCode.stop();
          isScannerRunning = false;
        } catch (e) {
          console.error("Error stopping scanner:", e);
        }
      }
    }
    
    function refreshScanner() {
      stopScanner();
      
      Swal.fire({
        title: 'Merefresh Scanner...',
        allowOutsideClick: false,
        timer: 1000,
        timerProgressBar: true,
        didOpen: () => {
          Swal.showLoading();
        }
      }).then(() => {
        startScanner();
        showToast('success', 'Scanner Siap!', 'QR Code scanner telah direfresh');
      });
    }
    
    function onScanSuccess(decodedText) {
      stopScanner();
      console.log("QR Code detected:", decodedText);
      playScanSound();
      
      let jenis = "";
      if (decodedText.includes("APEL_PAGI") || decodedText.toLowerCase().includes("pagi")) {
        jenis = "pagi";
      } else if (decodedText.includes("APEL_SORE") || decodedText.toLowerCase().includes("sore")) {
        jenis = "sore";
      }
      
      if (!jenis) {
        Swal.fire({
          icon: 'error',
          title: 'QR Code Tidak Valid',
          html: 'QR Code ini bukan untuk absensi apel.<br><br>Gunakan QR Code resmi dari Lapas Baubau.',
          confirmButtonText: 'OK',
          confirmButtonColor: '#1976d2'
        }).then(() => {
          startScanner();
        });
        return;
      }
      
      currentApelType = jenis;
      
      Swal.fire({
        icon: 'success',
        title: 'QR Code Berhasil Discan!',
        html: `<div style="text-align: center;">
                <div style="font-size: 3.5rem; color: #4CAF50; margin: 15px 0;">
                  <i class="fas fa-check-circle"></i>
                </div>
                <h4 style="color: #2e7d32; font-size: 1.5rem;">Apel ${jenis === 'pagi' ? 'Pagi' : 'Sore'}</h4>
                <p style="font-size: 1.1rem;">Memproses absensi...</p>
              </div>`,
        timer: 1500,
        showConfirmButton: false,
        background: '#f8f9fa'
      }).then(() => {
        if (!userData || !userData.nip || !userData.deviceId) {
          checkDeviceRegistrationBeforeAttendance(jenis);
        } else {
          proceedWithAttendance(jenis);
        }
      });
    }
    
    function onScanError(errorMessage) {
      if (!errorMessage.includes("NotFoundException")) {
        console.log("Scan debug:", errorMessage);
      }
    }
    
    function handleCameraError(err) {
      let errorMsg = "Tidak dapat mengakses kamera. ";
      if (err.name === 'NotAllowedError') {
        errorMsg = "Izin kamera ditolak. Izinkan akses kamera di pengaturan browser.";
      } else if (err.name === 'NotFoundError') {
        errorMsg = "Kamera tidak ditemukan. Pastikan kamera tersedia.";
      }
      
      Swal.fire({
        icon: 'error',
        title: 'Kamera Error',
        html: `${errorMsg}<br><br>
               <button id="manualQR" class="btn btn-primary" style="padding: 10px 20px; margin-top: 10px;">
                 <i class="fas fa-keyboard"></i> Input QR Code Manual
               </button>`,
        showConfirmButton: false,
        background: '#f8f9fa',
        didOpen: () => {
          document.getElementById('manualQR').addEventListener('click', () => {
            promptManualQRInput();
          });
        }
      });
    }
    
    // ============================================
    // ATTENDANCE PROCESSING
    // ============================================
    function checkDeviceRegistrationBeforeAttendance(jenis) {
      Swal.fire({
        title: 'Memeriksa Status Akun...',
        html: '<div style="text-align: center;">' +
              '<div class="spinner" style="width: 50px; height: 50px; margin: 0 auto 20px;"></div>' +
              '<p style="font-size: 1.1rem;">Memeriksa apakah perangkat Anda sudah terdaftar...</p>' +
              '</div>',
        allowOutsideClick: false,
        showConfirmButton: false,
        background: '#f8f9fa'
      });
      
      callGASFunction('checkRegistrationStatus', { deviceId: deviceId })
        .then(response => {
          Swal.close();
          
          if (response.status === "registered") {
            userData = {
              nip: response.nip,
              nama: response.nama,
              deviceId: deviceId,
              jabatan: response.jabatan || ""
            };
            
            saveUserData();
            updateUserInfo();
            proceedWithAttendance(jenis);
          } else {
            promptManualRegistration(jenis);
          }
        })
        .catch(error => {
          Swal.close();
          promptManualRegistration(jenis);
        });
    }
    
    function promptManualRegistration(jenis) {
      Swal.fire({
        icon: 'info',
        title: 'Perangkat Belum Terdaftar',
        html: `<div style="text-align: center;">
                 <p style="font-size: 1.1rem;">Perangkat Anda belum terdaftar di sistem.</p>
                 <div style="background: #fff3e0; padding: 20px; border-radius: 12px; margin: 20px 0; border-left: 5px solid #FF9800;">
                   <p style="font-size: 1.2rem;"><i class="fas fa-qrcode"></i> QR Code <strong>${jenis.toUpperCase()}</strong> berhasil discan</p>
                   <p style="font-size: 1rem;">Silakan daftarkan perangkat Anda terlebih dahulu</p>
                 </div>
               </div>`,
        confirmButtonText: 'Daftar Sekarang',
        confirmButtonColor: '#1976d2',
        showCancelButton: true,
        cancelButtonText: 'Nanti Saja',
        background: '#f8f9fa'
      }).then((result) => {
        if (result.isConfirmed) {
          showRegistrationScreen();
        } else {
          startScanner();
        }
      });
    }
    
    function proceedWithAttendance(jenis) {
      Swal.fire({
        title: 'Memproses Absensi',
        html: '<div style="text-align: center;">' +
              '<div class="spinner" style="width: 50px; height: 50px; margin: 0 auto 20px;"></div>' +
              '<p style="font-size: 1.1rem;">Mengambil lokasi Anda...</p>' +
              '</div>',
        allowOutsideClick: false,
        showConfirmButton: false,
        background: '#f8f9fa'
      });
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          submitAttendance(position.coords.latitude, position.coords.longitude, jenis);
        },
        (error) => {
          Swal.close();
          handleLocationError(error);
        },
        { 
          timeout: CONFIG.LOCATION_TIMEOUT, 
          enableHighAccuracy: true,
          maximumAge: 0
        }
      );
    }
    
    function submitAttendance(lat, lon, jenis) {
      Swal.update({
        title: 'Mengirim Absensi',
        html: '<div style="text-align: center;">' +
              '<div class="spinner" style="width: 50px; height: 50px; margin: 0 auto 20px;"></div>' +
              '<p style="font-size: 1.1rem;">Sedang mengirim data absensi ke server...</p>' +
              '</div>'
      });
      
      callGASFunction('submitAbsen', {
        nip: userData.nip,
        deviceId: userData.deviceId,
        jenisApel: jenis,
        latUser: lat,
        lonUser: lon
      })
      .then(response => {
        Swal.close();
        
        if (response.status === "success") {
          playSuccessSound();
          showAttendanceSuccess(response, jenis);
        } else if (response.message.includes("DEVICE")) {
          handleDeviceRegistrationError(response);
        } else {
          showAttendanceError(response);
        }
      })
      .catch(error => {
        Swal.close();
        console.error("Server error:", error);
        showToast('error', 'Kesalahan Server', 'Periksa koneksi internet Anda dan coba lagi')
          .then(() => {
            startScanner();
          });
      });
    }
    
    // ============================================
    // REGISTRATION PROCESS
    // ============================================
    function submitRegistration() {
      const nip = regNip.value.trim();
      
      // Validation
      if (!nip) {
        showToast('warning', 'NIP Kosong', 'Masukkan NIP terlebih dahulu');
        regNip.focus();
        return;
      }
      
      if (!/^\d+$/.test(nip)) {
        Swal.fire({
          icon: 'warning',
          title: 'Format NIP Tidak Valid',
          html: 'NIP hanya boleh berisi angka.<br><br>Contoh: 197001012000011001',
          confirmButtonText: 'OK',
          confirmButtonColor: '#1976d2'
        });
        regNip.focus();
        regNip.select();
        return;
      }
      
      if (nip.length < CONFIG.MIN_NIP_LENGTH || nip.length > CONFIG.MAX_NIP_LENGTH) {
        Swal.fire({
          icon: 'warning',
          title: 'Panjang NIP Tidak Sesuai',
          html: `NIP harus antara ${CONFIG.MIN_NIP_LENGTH}-${CONFIG.MAX_NIP_LENGTH} digit.<br><br>Contoh: 197001012000011001`,
          confirmButtonText: 'OK',
          confirmButtonColor: '#1976d2'
        });
        regNip.focus();
        regNip.select();
        return;
      }
      
      Swal.fire({
        title: 'Memeriksa Data Pegawai...',
        html: `<div style="text-align: center;">
                <div class="spinner" style="width: 50px; height: 50px; margin: 0 auto 20px;"></div>
                <p style="font-size: 1.1rem;">Memeriksa NIP: <strong>${nip}</strong></p>
                <small>Sedang memvalidasi data di sistem...</small>
               </div>`,
        allowOutsideClick: false,
        showConfirmButton: false,
        background: '#f8f9fa'
      });
      
      callGASFunction('checkDuplicateRegistration', {
        nip: nip,
        deviceId: deviceId
      })
      .then(response => {
        Swal.close();
        handleRegistrationResponse(response, nip);
      })
      .catch(error => {
        Swal.close();
        showToast('error', 'Koneksi Gagal', 'Tidak dapat terhubung ke server. Periksa koneksi internet Anda');
      });
    }
    
    function handleRegistrationResponse(result, nip) {
      switch(result.status) {
        case "duplicate":
          handleDuplicateRegistration(result);
          break;
        case "available":
          handleAvailableRegistration(nip, result);
          break;
        case "device_duplicate":
          showDeviceDuplicateError(result);
          break;
        case "nip_duplicate":
          showNipDuplicateError(result, nip);
          break;
        case "error":
          showRegistrationError(result);
          break;
        default:
          showToast('error', 'Status Tidak Dikenali', 'Terjadi kesalahan tidak terduga');
      }
    }
    
    function handleDuplicateRegistration(result) {
      userData = {
        nip: result.nip,
        nama: result.nama,
        deviceId: result.deviceId,
        jabatan: result.jabatan || ""
      };
      
      saveUserData();
      updateUserInfo();
      
      Swal.fire({
        icon: 'success',
        title: 'Akun Ditemukan!',
        html: `<div style="text-align: center;">
                 <div style="font-size: 4.5rem; color: #4CAF50; margin-bottom: 20px;">
                   <i class="fas fa-user-check"></i>
                 </div>
                 <h3 style="color: #2e7d32; font-size: 1.6rem;">Selamat Datang Kembali!</h3>
                 <div style="background: #f0f8ff; padding: 25px; border-radius: 12px; margin: 20px 0; text-align: left; font-size: 1.1rem;">
                   <p><strong>Nama:</strong> ${result.nama}</p>
                   <p><strong>NIP:</strong> ${result.nip}</p>
                   ${result.jabatan ? `<p><strong>Jabatan:</strong> ${result.jabatan}</p>` : ''}
                   <p><strong>Status:</strong> <span style="color: #4CAF50; font-weight: bold;">Sudah Terdaftar</span></p>
                 </div>
                 <p style="font-size: 1rem; color: #666;">
                   Anda akan langsung dialihkan ke scanner...
                 </p>
               </div>`,
        timer: 3000,
        timerProgressBar: true,
        showConfirmButton: false,
        background: '#f8f9fa'
      }).then(() => {
        showScannerScreen();
      });
    }
    
    function handleAvailableRegistration(nip, result) {
      Swal.fire({
        icon: 'info',
        title: 'Konfirmasi Data Pegawai',
        html: `<div style="text-align: center;">
                 <div style="font-size: 3.5rem; color: #2196F3; margin-bottom: 20px;">
                   <i class="fas fa-user-tie"></i>
                 </div>
                 <p style="font-size: 1.2rem;">Data ditemukan di sistem:</p>
                 <div style="background: #e8f5e9; padding: 25px; border-radius: 12px; margin: 20px 0; text-align: left; font-size: 1.1rem;">
                   <p><strong>Nama:</strong> ${result.nama}</p>
                   <p><strong>NIP:</strong> ${nip}</p>
                   ${result.jabatan ? `<p><strong>Jabatan:</strong> ${result.jabatan}</p>` : ''}
                 </div>
                 <p style="font-size: 1.1rem;">Apakah data di atas sudah benar?</p>
               </div>`,
        showCancelButton: true,
        confirmButtonText: 'Ya, Data Benar',
        confirmButtonColor: '#4CAF50',
        cancelButtonText: 'Periksa Kembali',
        cancelButtonColor: '#757575',
        reverseButtons: true,
        background: '#f8f9fa',
        width: isMobileDevice() ? '90%' : '500px'
      }).then((confirmation) => {
        if (confirmation.isConfirmed) {
          proceedWithRegistration(nip, result);
        } else {
          regNip.focus();
          regNip.select();
        }
      });
    }
    
    function proceedWithRegistration(nip, preCheckResult) {
      Swal.fire({
        title: 'Mendaftarkan Akun',
        html: `<div style="text-align: center;">
                <div class="spinner" style="width: 50px; height: 50px; margin: 0 auto 20px;"></div>
                <p style="font-size: 1.1rem;">Mendaftarkan: <strong>${preCheckResult.nama}</strong></p>
                <small>Mohon tunggu beberapa saat...</small>
               </div>`,
        allowOutsideClick: false,
        showConfirmButton: false,
        background: '#f8f9fa'
      });
      
      callGASFunction('signupUser', {
        nip: nip,
        deviceId: deviceId
      })
      .then(response => {
        Swal.close();
        
        if (response.status === "ok") {
          userData = {
            nip: response.nip,
            nama: response.nama,
            deviceId: deviceId,
            jabatan: response.jabatan || ""
          };
          
          saveUserData();
          updateUserInfo();
          
          Swal.fire({
            icon: 'success',
            title: 'Pendaftaran Berhasil!',
            html: `<div style="text-align: center;">
                     <div style="font-size: 4.5rem; color: #4CAF50; margin-bottom: 20px;">
                       <i class="fas fa-user-check"></i>
                     </div>
                     <h3 style="color: #2e7d32; font-size: 1.6rem;">Selamat Bergabung!</h3>
                     <div style="background: #f0f8ff; padding: 25px; border-radius: 12px; margin: 20px 0; text-align: left; font-size: 1.1rem;">
                       <p><strong>Nama:</strong> ${response.nama}</p>
                       <p><strong>NIP:</strong> ${response.nip}</p>
                       ${response.jabatan ? `<p><strong>Jabatan:</strong> ${response.jabatan}</p>` : ''}
                       <p><strong>Status:</strong> <span style="color: #4CAF50; font-weight: bold;">AKTIF</span></p>
                       <p><strong>Tanggal Daftar:</strong> ${new Date().toLocaleDateString('id-ID')}</p>
                     </div>
                     <p style="font-size: 1rem; color: #666;">
                       Akun Anda sudah siap digunakan untuk absensi
                     </p>
                   </div>`,
            confirmButtonText: 'Mulai Absensi',
            confirmButtonColor: '#4CAF50',
            width: isMobileDevice() ? '90%' : '500px',
            background: '#f8f9fa'
          }).then(() => {
            showScannerScreen();
            
            if (currentApelType) {
              setTimeout(() => {
                proceedWithAttendance(currentApelType);
              }, 1500);
            }
          });
        } else {
          showRegistrationError(response);
        }
      })
      .catch(error => {
        Swal.close();
        showToast('error', 'Kesalahan Server', 'Terjadi kesalahan saat mendaftar. Periksa koneksi internet Anda');
      });
    }
    
    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function generateDeviceId() {
      let storedDeviceId = localStorage.getItem(STORAGE_KEYS.DEVICE_ID);
      if (!storedDeviceId) {
        const timestamp = Date.now();
        const random = Math.floor(Math.random() * 1000000);
        const userAgentHash = navigator.userAgent.length % 10000;
        storedDeviceId = `DEV_${timestamp}_${random}_${userAgentHash}`;
        localStorage.setItem(STORAGE_KEYS.DEVICE_ID, storedDeviceId);
      }
      deviceId = storedDeviceId;
      regDeviceId.value = storedDeviceId;
      return storedDeviceId;
    }
    
    function updateStatusAbsensi() {
      if (!userData || !userData.nip) return;
      
      callGASFunction('cekStatusAbsensiHariIni', { nip: userData.nip })
        .then(status => {
          if (status.sisaKesempatan !== undefined) {
            sisaKesempatanCount.textContent = status.sisaKesempatan;
            
            if (status.sisaKesempatan > 0) {
              sisaKesempatanBadge.style.background = 'var(--success)';
              sisaKesempatanBadge.classList.remove('d-none');
            } else if (status.sisaKesempatan === 0) {
              sisaKesempatanBadge.style.background = 'var(--danger)';
              sisaKesempatanBadge.classList.remove('d-none');
            }
          }
          
          if (status.totalAbsen >= 2) {
            scannerMessage.innerHTML = `
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="font-size: 1.8rem; color: var(--success);">
                  <i class="fas fa-check-circle"></i>
                </div>
                <div>
                  <p style="margin: 0; color: var(--success); font-weight: bold; font-size: 1.1rem;">
                    Anda sudah absen 2 kali hari ini (lengkap)
                  </p>
                  <p style="margin: 5px 0 0 0; color: var(--gray); font-size: 0.95rem;">
                    Pagi: ${status.waktuPagi || '-'} | Sore: ${status.waktuSore || '-'}
                  </p>
                </div>
              </div>
            `;
            scannerMessage.classList.remove('d-none');
          } else {
            scannerMessage.classList.add('d-none');
          }
        })
        .catch(error => {
          console.error("Error updating attendance status:", error);
        });
    }
    
    function logoutUser() {
      Swal.fire({
        title: 'Konfirmasi Logout',
        html: `Apakah Anda yakin ingin logout?<br><br>
               <small>Data login akan dihapus dari perangkat ini.</small>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ya, Logout',
        confirmButtonColor: '#d33',
        cancelButtonText: 'Batal',
        cancelButtonColor: '#1976d2'
      }).then((result) => {
        if (result.isConfirmed) {
          clearInvalidUserData();
          stopScanner();
          updateUserInfo();
          
          showToast('success', 'Logout Berhasil', 'Data login telah dihapus dari perangkat')
            .then(() => {
              setTimeout(() => {
                startScanner();
              }, 500);
            });
        }
      });
    }
    
    // ============================================
    // GAS FUNCTION CALLS
    // ============================================
    function callGASFunction(functionName, params = {}) {
      return new Promise((resolve, reject) => {
        // Add timestamp to prevent caching
        params._t = new Date().getTime();
        
        const urlParams = new URLSearchParams();
        urlParams.append('fn', functionName);
        Object.keys(params).forEach(key => {
          urlParams.append(key, params[key]);
        });
        
        fetch(`${CONFIG.GAS_WEB_APP_URL}?${urlParams.toString()}`, {
          method: 'GET',
          mode: 'cors',
          credentials: 'omit',
          headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.text();
        })
        .then(text => {
          try {
            const data = JSON.parse(text);
            resolve(data);
          } catch (e) {
            // If response is not JSON, return as text
            resolve(text);
          }
        })
        .catch(reject);
      });
    }
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    function adjustForMobile() {
      if (isMobileDevice()) {
        console.log("Mobile device detected - optimizing UI");
        
        if (window.innerWidth <= 360) {
          const buttons = document.querySelectorAll('.btn');
          buttons.forEach(btn => {
            btn.style.minHeight = '62px';
            btn.style.fontSize = '1.15rem';
          });
        }
        
        const scannerArea = document.querySelector('.scanner-area');
        if (scannerArea && window.innerHeight < 700) {
          scannerArea.style.minHeight = '55vh';
        }
      }
    }
    
    function handleVisibilityChange() {
      if (!document.hidden && scannerScreen.classList.contains('d-none') === false) {
        if (!isScannerRunning) {
          setTimeout(startScanner, 1000);
        }
      }
    }
    
    function playScanSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 1200;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.15);
      } catch (e) {
        // Sound not supported, ignore
      }
    }
    
    function playSuccessSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator1 = audioContext.createOscillator();
        const oscillator2 = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator1.connect(gainNode);
        oscillator2.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator1.frequency.value = 523.25;
        oscillator2.frequency.value = 659.25;
        oscillator1.type = 'sine';
        oscillator2.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.6);
        
        oscillator1.start(audioContext.currentTime);
        oscillator2.start(audioContext.currentTime);
        oscillator1.stop(audioContext.currentTime + 0.6);
        oscillator2.stop(audioContext.currentTime + 0.6);
      } catch (e) {
        // Sound not supported, ignore
      }
    }
    
    // ============================================
    // ERROR HANDLING FUNCTIONS
    // ============================================
    function handleLocationError(error) {
      let errorMessage = "Gagal mengakses lokasi";
      switch(error.code) {
        case error.PERMISSION_DENIED:
          errorMessage = "Izin lokasi ditolak. Aktifkan lokasi di pengaturan perangkat.";
          break;
        case error.POSITION_UNAVAILABLE:
          errorMessage = "Informasi lokasi tidak tersedia. Pastikan GPS aktif.";
          break;
        case error.TIMEOUT:
          errorMessage = "Permintaan lokasi timeout. Periksa koneksi internet.";
          break;
      }
      
      Swal.fire({
        icon: 'error',
        title: errorMessage,
        html: `Izinkan akses lokasi untuk melanjutkan absensi.<br><br>
               <small>Absensi memerlukan verifikasi lokasi untuk validasi kehadiran.</small>`,
        confirmButtonText: 'OK',
        confirmButtonColor: '#1976d2'
      }).then(() => {
        startScanner();
      });
    }
    
    function showDeviceDuplicateError(result) {
      Swal.fire({
        icon: 'error',
        title: 'Perangkat Sudah Terdaftar',
        html: `<div style="text-align: center;">
                <p style="font-size: 1.1rem;">Perangkat ini sudah terdaftar atas nama:</p>
                <div style="background: #ffebee; padding: 20px; border-radius: 12px; margin: 20px 0; border-left: 5px solid #f44336;">
                  <p style="font-size: 1.2rem; font-weight: bold;">${result.existingNama}</p>
                  <p>NIP: ${result.existingNip}</p>
                </div>
                <p style="color: #f44336; font-size: 1rem;">
                  <i class="fas fa-exclamation-triangle"></i> 
                  Satu perangkat hanya untuk satu akun
                </p>
               </div>`,
        confirmButtonText: 'OK',
        confirmButtonColor: '#1976d2'
      });
    }
    
    function showNipDuplicateError(result, nip) {
      Swal.fire({
        icon: 'warning',
        title: 'NIP Sudah Terdaftar',
        html: `<div style="text-align: center;">
                <p style="font-size: 1.1rem;">NIP <strong>${nip}</strong> sudah terdaftar dengan perangkat lain</p>
                <div style="background: #fff3e0; padding: 20px; border-radius: 12px; margin: 20px 0; border-left: 5px solid #FF9800;">
                  <p>Atas nama: <strong>${result.existingNama}</strong></p>
                  <p>Device ID: ${result.existingDevice.substring(0, 20)}...</p>
                </div>
                <p style="font-size: 1rem;">
                  Hubungi admin jika ini adalah perangkat baru Anda
                </p>
               </div>`,
        confirmButtonText: 'Hubungi Admin',
        confirmButtonColor: '#1976d2',
        showCancelButton: true,
        cancelButtonText: 'OK'
      }).then((result) => {
        if (result.isConfirmed) {
          window.open('https://wa.me/6281234567890?text=Halo%20Admin,%20saya%20perlu%20bantuan%20reset%20perangkat%20untuk%20NIP%20' + nip, '_blank');
        }
      });
    }
    
    function showRegistrationError(result) {
      Swal.fire({
        icon: 'error',
        title: 'Validasi Gagal',
        html: `<p style="font-size: 1.1rem;">${result.message}</p>
               <small>Pastikan NIP Anda benar dan terdaftar di sistem</small>`,
        confirmButtonText: 'OK',
        confirmButtonColor: '#1976d2'
      });
    }
    
    function handleDeviceRegistrationError(response) {
      Swal.fire({
        icon: 'warning',
        title: 'Perangkat Tidak Terdaftar',
        html: `<p style="font-size: 1.1rem;">${response.message}</p>
               <small>Perangkat Anda perlu didaftarkan ulang ke sistem.</small>`,
        confirmButtonText: 'Daftar Ulang',
        confirmButtonColor: '#1976d2'
      }).then(() => {
        clearInvalidUserData();
        updateUserInfo();
        showRegistrationScreen();
      });
    }
    
    function showAttendanceSuccess(response, jenis) {
      Swal.fire({
        icon: 'success',
        title: 'Absensi Berhasil!',
        html: `<div style="text-align: center;">
                 <div style="font-size: 4.5rem; color: #4CAF50; margin-bottom: 20px;">
                   <i class="fas fa-check-circle"></i>
                 </div>
                 <h3 style="color: #2e7d32; font-size: 1.6rem;">${response.message}</h3>
                 <div style="background: #f0f8ff; padding: 20px; border-radius: 12px; margin: 20px 0; text-align: left; font-size: 1.1rem;">
                   <p><strong>Jenis Apel:</strong> ${jenis === 'pagi' ? 'Apel Pagi' : 'Apel Sore'}</p>
                   <p><strong>Waktu:</strong> ${new Date().toLocaleTimeString('id-ID')}</p>
                   <p><strong>Tanggal:</strong> ${new Date().toLocaleDateString('id-ID')}</p>
                 </div>
                 <p style="font-size: 1rem; color: #666;">Absensi telah tercatat di sistem</p>
               </div>`,
        confirmButtonText: 'Selesai',
        confirmButtonColor: '#4CAF50',
        allowOutsideClick: false,
        width: isMobileDevice() ? '90%' : '500px',
        background: '#f8f9fa'
      }).then(() => {
        updateStatusAbsensi();
        startScanner();
      });
    }
    
    function showAttendanceError(response) {
      Swal.fire({
        icon: 'error',
        title: 'Absensi Gagal',
        html: `<p style="font-size: 1.1rem;">${response.message}</p>
               <small>Silakan scan ulang QR Code jika sudah sesuai ketentuan waktu dan lokasi.</small>`,
        confirmButtonText: 'OK',
        confirmButtonColor: '#1976d2'
      }).then(() => {
        startScanner();
      });
    }
    
    function promptManualQRInput() {
      Swal.fire({
        title: 'Input QR Code Manual',
        html: `<input type="text" id="manualQRInput" class="swal2-input" placeholder="Masukkan kode QR di sini" style="width: 80%; font-size: 1.1rem; padding: 15px;">`,
        showCancelButton: true,
        confirmButtonText: 'Submit',
        cancelButtonText: 'Batal',
        preConfirm: () => {
          const qrCode = document.getElementById('manualQRInput').value;
          if (!qrCode) {
            Swal.showValidationMessage('Masukkan kode QR terlebih dahulu');
            return false;
          }
          return qrCode;
        }
      }).then((result) => {
        if (result.isConfirmed && result.value) {
          onScanSuccess(result.value);
        }
      });
    }
    
    // ============================================
    // NOTIFICATION FUNCTIONS
    // ============================================
    function showToast(icon, title, text, timer = 2000) {
      return Swal.fire({
        icon: icon,
        title: title,
        text: text,
        timer: timer,
        showConfirmButton: false,
        toast: true,
        position: 'top'
      });
    }
    
    // ============================================
    // RESIZE HANDLING
    // ============================================
    let resizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(function() {
        adjustForMobile();
        
        if (!registerScreen.classList.contains('d-none') === false && isScannerRunning) {
          stopScanner();
          setTimeout(startScanner, 500);
        }
      }, 250);
    });
    
    // ============================================
    // SERVICE WORKER REGISTRATION (PWA)
    // ============================================
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js').then(registration => {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }).catch(err => {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }
  </script>
</body>
</html>
