<!DOCTYPE html>
<html lang="id">
<head>
  <base target="_top">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1976d2">
  
  <!-- Meta tag untuk mobile -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Absensi Apel">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-TileColor" content="#1976d2">
  
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Font Google -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

  <style>
    /* Reset dan variabel */
    :root {
      --primary: #1976d2;
      --primary-dark: #0d47a1;
      --primary-light: #bbdefb;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --border-radius: 16px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --box-shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
      --transition: all 0.3s ease;
    }
    
    html {
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: rgba(25, 118, 210, 0.2);
    }
    
    body {
      font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: var(--dark);
      min-height: 100vh;
      line-height: 1.6;
      overflow-x: hidden;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    /* Container utama */
    .container {
      max-width: 100%;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 12px;
    }
    
    /* Header - DIPERBESAR untuk HP */
    .header {
      text-align: center;
      margin-bottom: 15px;
      padding: 20px 15px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      flex-shrink: 0;
      position: relative;
    }
    
    .header-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 18px;
      margin-bottom: 15px;
    }
    
    .header-logo i {
      font-size: 3.2rem;
      background: rgba(255, 255, 255, 0.25);
      padding: 22px;
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.3);
    }
    
    .header h1 {
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 1.9rem;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .header p {
      font-size: 1.15rem;
      opacity: 0.95;
      font-weight: 400;
    }
    
    #datetime {
      margin-top: 12px;
      font-size: 1.1rem;
      background: rgba(255, 255, 255, 0.15);
      padding: 8px 15px;
      border-radius: 50px;
      display: inline-block;
      font-weight: 500;
    }
    
    /* Logout Button */
    .logout-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      font-size: 1.3rem;
      z-index: 100;
    }
    
    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
    }
    
    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    /* User Info - DIPERBESAR */
    .user-info {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      border-radius: var(--border-radius);
      padding: 22px 20px;
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
      border-left: 8px solid var(--primary);
      box-shadow: var(--box-shadow);
    }
    
    .user-avatar {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 2.2rem;
      flex-shrink: 0;
      border: 4px solid white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .user-details h3 {
      font-size: 1.5rem;
      margin-bottom: 8px;
      color: var(--primary-dark);
      font-weight: 700;
    }
    
    .user-details p {
      font-size: 1.15rem;
      color: var(--gray);
      margin-bottom: 6px;
      font-weight: 500;
    }
    
    /* Status Bar - DIPERBESAR dan JELAS */
    .status-bar {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      background: white;
      border-radius: var(--border-radius);
      padding: 22px 20px;
      margin-bottom: 20px;
      box-shadow: var(--box-shadow);
      border: 2px solid var(--primary-light);
    }
    
    .status-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 10px 5px;
    }
    
    .status-icon {
      font-size: 2.5rem;
      margin-bottom: 12px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(25, 118, 210, 0.1);
    }
    
    .status-label {
      font-size: 1rem;
      color: var(--gray);
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .status-value {
      font-size: 1.3rem;
      font-weight: 800;
      color: var(--dark);
    }
    
    /* Scanner Container - AREA BESAR untuk HP */
    .scanner-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-bottom: 20px;
      min-height: 60vh;
    }
    
    .scanner-card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow-lg);
      overflow: hidden;
      flex: 1;
      display: flex;
      flex-direction: column;
      border: 2px solid var(--primary-light);
      position: relative;
    }
    
    .card-header {
      background: var(--primary-light);
      color: var(--primary-dark);
      padding: 22px 20px;
      font-weight: 700;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 15px;
      flex-shrink: 0;
      border-bottom: 3px solid var(--primary);
    }
    
    .card-header i {
      font-size: 1.8rem;
    }
    
    .card-body {
      padding: 0;
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    /* QR Scanner Area - FULLSCREEN untuk HP */
    .scanner-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
      min-height: 450px;
      width: 100%;
      background: #000;
    }
    
    #reader {
      width: 100% !important;
      height: 100% !important;
      flex: 1;
      min-height: 450px;
      background: #000;
      position: relative;
    }
    
    #reader video {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
    }
    
    #reader__scan_region {
      width: 100% !important;
      height: 100% !important;
      background: transparent !important;
      display: flex !important;
      align-items: center;
      justify-content: center;
    }
    
    #reader__scan_region video,
    #reader__scan_region canvas,
    #reader__scan_region img {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
    }
    
    /* Scanner Instructions - DIPERBESAR */
    .scanner-instructions {
      text-align: center;
      padding: 25px 20px;
      background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
      color: white;
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      flex-shrink: 0;
      margin-top: auto;
      z-index: 5;
    }
    
    .scanner-instructions p {
      margin-bottom: 12px;
      color: white;
      font-size: 1.2rem;
      font-weight: 500;
    }
    
    .scanner-instructions .highlight {
      color: #4CAF50;
      font-weight: 700;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .instruction-icons {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }
    
    .instruction-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      flex: 1;
    }
    
    .instruction-icon i {
      font-size: 2.2rem;
      color: #4CAF50;
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 50%;
      width: 70px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .instruction-icon span {
      font-size: 1.05rem;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 500;
    }
    
    /* Action Buttons - BESAR untuk SENTUHAN */
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 20px;
      flex-shrink: 0;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      padding: 22px 20px;
      font-size: 1.2rem;
      font-weight: 700;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      width: 100%;
      font-family: 'Poppins', sans-serif;
      min-height: 65px;
      letter-spacing: 0.5px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    }
    
    .btn:active {
      transform: scale(0.97);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
    }
    
    .btn-primary {
      background: linear-gradient(to right, var(--primary), var(--primary-dark));
      color: white;
    }
    
    .btn-primary:hover {
      background: linear-gradient(to right, var(--primary-dark), var(--primary));
      box-shadow: 0 8px 25px rgba(25, 118, 210, 0.4);
    }
    
    .btn-warning {
      background: linear-gradient(to right, var(--warning), #ef6c00);
      color: white;
    }
    
    .btn-warning:hover {
      background: linear-gradient(to right, #ef6c00, var(--warning));
      box-shadow: 0 8px 25px rgba(255, 152, 0, 0.4);
    }
    
    .btn-success {
      background: linear-gradient(to right, var(--success), #2e7d32);
      color: white;
    }
    
    .btn-success:hover {
      background: linear-gradient(to right, #2e7d32, var(--success));
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
    }
    
    .btn i {
      font-size: 1.5rem;
    }
    
    /* Loading Screen - DIPERBESAR */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
      flex: 1;
      background: white;
      border-radius: var(--border-radius);
    }
    
    .spinner {
      width: 80px;
      height: 80px;
      border: 8px solid var(--primary-light);
      border-top: 8px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 30px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading p {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 10px;
    }
    
    .loading .text-muted {
      font-size: 1.1rem;
      color: var(--gray);
    }
    
    /* Registration Screen - DIPERBESAR */
    .registration-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .form-group {
      margin-bottom: 30px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 15px;
      font-weight: 600;
      color: var(--dark);
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .input-with-icon {
      position: relative;
    }
    
    .input-icon {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
      font-size: 1.5rem;
      z-index: 2;
    }
    
    input {
      width: 100%;
      padding: 22px 20px 22px 65px;
      border: 3px solid var(--gray-light);
      border-radius: 12px;
      font-size: 1.3rem;
      font-family: inherit;
      transition: var(--transition);
      background: white;
      font-weight: 500;
    }
    
    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 5px rgba(25, 118, 210, 0.2);
    }
    
    .form-group small {
      display: block;
      margin-top: 10px;
      font-size: 1.05rem;
      color: var(--gray);
      padding-left: 5px;
    }
    
    /* Footer - DIPERBESAR */
    .footer {
      text-align: center;
      padding: 25px 20px;
      color: var(--gray);
      font-size: 1.1rem;
      margin-top: 25px;
      border-top: 2px solid var(--gray-light);
      flex-shrink: 0;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }
    
    .footer p {
      margin-bottom: 12px;
      font-weight: 500;
    }
    
    /* Badge untuk sisa kesempatan */
    .sisa-kesempatan-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      background: var(--success);
      color: white;
      padding: 10px 18px;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: 700;
      z-index: 10;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      border: 2px solid white;
    }
    
    /* Scanner message */
    .scanner-message {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 12px;
      z-index: 10;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border-left: 5px solid var(--success);
    }
    
    /* Cookie banner */
    .cookie-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 20px;
      z-index: 1000;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }
    
    .cookie-content {
      flex: 1;
    }
    
    .cookie-content p {
      margin: 0;
      font-size: 1.05rem;
    }
    
    .cookie-buttons {
      display: flex;
      gap: 10px;
      flex-shrink: 0;
    }
    
    .cookie-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      min-width: 100px;
    }
    
    .cookie-btn-accept {
      background: white;
      color: var(--primary);
    }
    
    .cookie-btn-decline {
      background: transparent;
      color: white;
      border: 2px solid white;
    }
    
    /* Responsive Design untuk berbagai ukuran HP */
    @media (max-width: 768px) {
      html {
        font-size: 17px;
      }
      
      .container {
        padding: 10px;
      }
      
      .header {
        padding: 18px 15px;
      }
      
      .header h1 {
        font-size: 1.7rem;
      }
      
      .header-logo i {
        font-size: 2.8rem;
        padding: 20px;
      }
      
      .action-buttons {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .btn {
        padding: 20px 18px;
        font-size: 1.15rem;
      }
      
      .logout-btn {
        width: 45px;
        height: 45px;
        font-size: 1.2rem;
      }
    }
    
    @media (max-width: 480px) {
      html {
        font-size: 18px;
      }
      
      .container {
        padding: 8px;
      }
      
      .header h1 {
        font-size: 1.6rem;
      }
      
      .header p {
        font-size: 1.1rem;
      }
      
      .user-info {
        flex-direction: column;
        text-align: center;
        gap: 15px;
        padding: 20px 15px;
      }
      
      .user-avatar {
        width: 70px;
        height: 70px;
        font-size: 2rem;
      }
      
      .user-details h3 {
        font-size: 1.4rem;
      }
      
      .status-bar {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .status-item {
        flex-direction: row;
        text-align: left;
        gap: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 12px;
      }
      
      .status-icon {
        margin-bottom: 0;
        width: 50px;
        height: 50px;
        font-size: 2rem;
        flex-shrink: 0;
      }
      
      .status-content {
        flex: 1;
      }
      
      .scanner-area {
        min-height: 400px;
      }
      
      .scanner-instructions {
        padding: 20px 15px;
      }
      
      .scanner-instructions p {
        font-size: 1.1rem;
      }
      
      .instruction-icons {
        flex-direction: column;
        gap: 20px;
      }
      
      .instruction-icon {
        flex-direction: row;
        justify-content: flex-start;
        gap: 15px;
      }
      
      .instruction-icon i {
        width: 60px;
        height: 60px;
        font-size: 1.8rem;
        flex-shrink: 0;
      }
      
      .instruction-icon span {
        font-size: 1rem;
      }
    }
    
    @media (max-width: 360px) {
      .header h1 {
        font-size: 1.4rem;
      }
      
      .header p {
        font-size: 1rem;
      }
      
      .btn {
        font-size: 1.1rem;
        padding: 18px 15px;
        min-height: 60px;
      }
      
      .btn i {
        font-size: 1.4rem;
      }
      
      .card-header {
        font-size: 1.2rem;
        padding: 20px 15px;
      }
    }
    
    /* Landscape Mode untuk HP */
    @media (orientation: landscape) and (max-height: 600px) {
      .scanner-container {
        min-height: 70vh;
      }
      
      .header {
        padding: 15px 12px;
        margin-bottom: 10px;
      }
      
      .header h1 {
        font-size: 1.4rem;
      }
      
      .header p {
        font-size: 1rem;
      }
      
      .header-logo i {
        font-size: 2rem;
        padding: 15px;
      }
      
      .user-info {
        margin-bottom: 10px;
        padding: 15px;
      }
      
      .status-bar {
        padding: 15px;
        margin-bottom: 10px;
      }
      
      .btn {
        padding: 18px 15px;
        min-height: 55px;
        font-size: 1.1rem;
      }
      
      .scanner-instructions {
        padding: 15px;
      }
      
      .scanner-instructions p {
        font-size: 1rem;
      }
      
      .instruction-icon i {
        font-size: 1.5rem;
        width: 50px;
        height: 50px;
      }
    }
    
    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      :root {
        --light: #2d3748;
        --dark: #f7fafc;
        --gray-light: #4a5568;
      }
      
      body {
        background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
        color: var(--dark);
      }
      
      .scanner-card, .status-bar, .user-info {
        background: #2d3748;
      }
      
      input {
        background: #4a5568;
        color: white;
        border-color: #718096;
      }
      
      .footer {
        background: #2d3748;
        color: #cbd5e0;
      }
    }
    
    /* Utility Classes */
    .text-center { text-align: center; }
    .text-muted { color: var(--gray); }
    .mt-1 { margin-top: 15px; }
    .mt-2 { margin-top: 25px; }
    .mb-1 { margin-bottom: 15px; }
    .mb-2 { margin-bottom: 25px; }
    .d-none { display: none !important; }
    .d-flex { display: flex; }
    .d-block { display: block; }
    .highlight { color: var(--primary-dark); font-weight: 700; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header dengan Logout Button -->
    <header class="header">
      <button id="logoutBtn" class="logout-btn d-none" title="Logout">
        <i class="fas fa-sign-out-alt"></i>
      </button>
      <div class="header-logo">
        <i class="fas fa-calendar-check"></i>
      </div>
      <h1>ABSENSI APEL LAPAS BAUBAU</h1>
      <p>Scan QR Code untuk absensi apel pagi/sore</p>
      <div id="datetime" class="mt-1"></div>
    </header>
    
    <!-- Main Content -->
    <main class="main-content" id="mainContent">
      <!-- Loading Screen -->
      <div id="loadingScreen" class="loading">
        <div class="spinner"></div>
        <p id="loadingText">Memuat sistem scanner...</p>
        <p class="text-muted">Harap tunggu sebentar</p>
      </div>
      
      <!-- Scanner Screen -->
      <div id="scannerScreen" class="scanner-container d-none">
        <!-- User Info -->
        <div id="userInfoCard" class="user-info d-none">
          <div class="user-avatar">
            <i class="fas fa-user-tie"></i>
          </div>
          <div class="user-details">
            <h3 id="userName">Nama Pegawai</h3>
            <p>NIP: <span id="userNip">-</span></p>
            <p id="userStatus">Status: <span class="highlight">Belum terdaftar</span></p>
          </div>
        </div>
        
        <!-- Status Bar -->
        <div class="status-bar">
          <div class="status-item">
            <div class="status-icon" style="color: var(--primary);">
              <i class="fas fa-clock"></i>
            </div>
            <div class="status-content">
              <div class="status-label">WAKTU</div>
              <div class="status-value" id="currentTime">--:--</div>
            </div>
          </div>
          
          <div class="status-item">
            <div class="status-icon" style="color: var(--success);">
              <i class="fas fa-calendar-day"></i>
            </div>
            <div class="status-content">
              <div class="status-label">TANGGAL</div>
              <div class="status-value" id="currentDate">-- --- ----</div>
            </div>
          </div>
          
          <div class="status-item">
            <div class="status-icon" style="color: var(--warning);">
              <i class="fas fa-map-marker-alt"></i>
            </div>
            <div class="status-content">
              <div class="status-label">LOKASI</div>
              <div class="status-value" id="locationStatus">--</div>
            </div>
          </div>
        </div>
        
        <!-- Scanner Card -->
        <div class="scanner-card">
          <!-- Badge Sisa Kesempatan -->
          <div id="sisaKesempatanBadge" class="sisa-kesempatan-badge d-none">
            Sisa: <span id="sisaKesempatanCount">2</span>/2
          </div>
          
          <!-- Scanner Message -->
          <div id="scannerMessage" class="scanner-message d-none"></div>
          
          <div class="card-header">
            <i class="fas fa-qrcode"></i>
            SCAN QR CODE APEL
          </div>
          <div class="card-body">
            <div class="scanner-area">
              <div id="reader"></div>
            </div>
            
            <div class="scanner-instructions">
              <p class="highlight">
                <i class="fas fa-info-circle"></i> 
                ARAHKAN KAMERA KE QR CODE APEL
              </p>
              <p>Posisikan QR Code dalam area kamera</p>
              
              <div class="instruction-icons">
                <div class="instruction-icon">
                  <i class="fas fa-qrcode"></i>
                  <span>Scan QR Code</span>
                </div>
                <div class="instruction-icon">
                  <i class="fas fa-lightbulb"></i>
                  <span>Cahaya Cukup</span>
                </div>
                <div class="instruction-icon">
                  <i class="fas fa-hand-steady"></i>
                  <span>Tangan Stabil</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
          <button id="registerBtn" class="btn btn-warning">
            <i class="fas fa-user-plus"></i> 
            <span>DAFTAR AKUN BARU</span>
          </button>
          <button id="refreshBtn" class="btn btn-success">
            <i class="fas fa-redo-alt"></i> 
            <span>REFRESH SCANNER</span>
          </button>
        </div>
      </div>
      
      <!-- Registration Screen -->
      <div id="registerScreen" class="registration-screen d-none">
        <div class="scanner-card">
          <div class="card-header">
            <i class="fas fa-user-plus"></i> 
            PENDAFTARAN AKUN BARU
          </div>
          <div class="card-body" style="padding: 25px 20px;">
            <div class="user-info mb-2" style="background: #e8f5e9; border-color: #4CAF50;">
              <div class="user-avatar" style="background: #4CAF50;">
                <i class="fas fa-user-edit"></i>
              </div>
              <div class="user-details">
                <h3 style="color: #2e7d32;">Pendaftaran Pegawai</h3>
                <p class="text-muted">Masukkan NIP Anda untuk mendaftar</p>
              </div>
            </div>
            
            <div class="form-group">
              <label for="regNip">
                <i class="fas fa-id-card"></i> 
                NIP PEGAWAI
              </label>
              <div class="input-with-icon">
                <i class="input-icon fas fa-id-card"></i>
                <input type="text" id="regNip" placeholder="Contoh: 197001012000011001" maxlength="20">
              </div>
              <small>Masukkan NIP sesuai yang terdaftar di Lapas Baubau</small>
            </div>
            
            <div class="form-group">
              <label>
                <i class="fas fa-info-circle"></i> 
                INFORMASI PERANGKAT
              </label>
              <div class="input-with-icon">
                <i class="input-icon fas fa-mobile-alt"></i>
                <input type="text" id="regDeviceId" readonly style="background: #f8f9fa; color: #666;">
              </div>
              <small>ID unik perangkat Anda untuk keamanan</small>
            </div>
            
            <div class="action-buttons" style="grid-template-columns: 1fr; gap: 20px; margin-top: 30px;">
              <button id="submitRegisterBtn" class="btn btn-success">
                <i class="fas fa-check-circle"></i> 
                DAFTARKAN AKUN
              </button>
              <button id="backToScannerBtn" class="btn btn-primary">
                <i class="fas fa-arrow-left"></i> 
                KEMBALI KE SCANNER
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
    
    <!-- Footer -->
    <footer class="footer">
      <p>Â© 2023 Lapas Baubau | Sistem Absensi Apel Digital</p>
      <p>Untuk bantuan, hubungi admin di ruang IT</p>
      <p style="font-size: 1rem; margin-top: 10px;">
        <i class="fas fa-mobile-alt"></i> 
        Versi Mobile | Data tersimpan di perangkat
      </p>
    </footer>
  </div>

  <!-- Cookie Consent Banner -->
  <div id="cookieBanner" class="cookie-banner d-none">
    <div class="cookie-content">
      <p>
        <i class="fas fa-cookie-bite"></i> 
        Sistem ini menggunakan penyimpanan lokal perangkat untuk menyimpan data login Anda. 
        Data hanya disimpan di perangkat Anda dan tidak dikirim ke server lain.
      </p>
    </div>
    <div class="cookie-buttons">
      <button id="cookieAccept" class="cookie-btn cookie-btn-accept">Terima</button>
      <button id="cookieDecline" class="cookie-btn cookie-btn-decline">Tolak</button>
    </div>
  </div>

  <script>
    // Global variables
    let userData = null;
    let html5QrCode = null;
    let currentApelType = null;
    let isScannerRunning = false;
    let isAutoLoginAttempted = false;
    
    // DOM Elements
    const loadingScreen = document.getElementById('loadingScreen');
    const scannerScreen = document.getElementById('scannerScreen');
    const registerScreen = document.getElementById('registerScreen');
    const userInfoCard = document.getElementById('userInfoCard');
    const userName = document.getElementById('userName');
    const userNip = document.getElementById('userNip');
    const userStatus = document.getElementById('userStatus');
    const currentTime = document.getElementById('currentTime');
    const currentDate = document.getElementById('currentDate');
    const locationStatus = document.getElementById('locationStatus');
    const datetimeElement = document.getElementById('datetime');
    const registerBtn = document.getElementById('registerBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const regNip = document.getElementById('regNip');
    const regDeviceId = document.getElementById('regDeviceId');
    const submitRegisterBtn = document.getElementById('submitRegisterBtn');
    const backToScannerBtn = document.getElementById('backToScannerBtn');
    const sisaKesempatanBadge = document.getElementById('sisaKesempatanBadge');
    const sisaKesempatanCount = document.getElementById('sisaKesempatanCount');
    const scannerMessage = document.getElementById('scannerMessage');
    const logoutBtn = document.getElementById('logoutBtn');
    const loadingText = document.getElementById('loadingText');
    const cookieBanner = document.getElementById('cookieBanner');
    const cookieAccept = document.getElementById('cookieAccept');
    const cookieDecline = document.getElementById('cookieDecline');
    
    // Storage Keys
    const STORAGE_KEYS = {
      USER_DATA: 'absensi_apel_user_data',
      DEVICE_ID: 'absensi_apel_device_id',
      COOKIE_CONSENT: 'absensi_apel_cookie_consent',
      LAST_LOGIN: 'absensi_apel_last_login'
    };
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Initializing Absensi Apel System...');
      
      // Check cookie consent first
      checkCookieConsent();
      
      // Adjust UI for mobile
      adjustForMobile();
      
      // Generate device ID for registration
      generateDeviceId();
      
      // Initialize date/time display
      updateDateTime();
      setInterval(updateDateTime, 1000);
      
      // Check location status
      checkLocationStatus();
      
      // Event listeners
      registerBtn.addEventListener('click', showRegistrationScreen);
      refreshBtn.addEventListener('click', refreshScanner);
      submitRegisterBtn.addEventListener('click', submitRegistration);
      backToScannerBtn.addEventListener('click', showScannerScreen);
      logoutBtn.addEventListener('click', logoutUser);
      cookieAccept.addEventListener('click', acceptCookies);
      cookieDecline.addEventListener('click', declineCookies);
      
      // Tambahkan event listener untuk input NIP
      regNip.addEventListener('input', function(e) {
        // Format NIP: hanya angka
        this.value = this.value.replace(/\D/g, '');
      });
      
      // Handle back button (Android)
      window.addEventListener('popstate', function(e) {
        if (!registerScreen.classList.contains('d-none')) {
          showScannerScreen();
          e.preventDefault();
        }
      });
      
      // Handle online/offline status
      window.addEventListener('online', function() {
        Swal.fire({
          icon: 'success',
          title: 'Koneksi Dipulihkan',
          text: 'Anda kembali terhubung ke internet',
          timer: 2000,
          showConfirmButton: false,
          toast: true,
          position: 'top'
        });
        
        if (userData && userData.nip) {
          updateStatusAbsensi();
        }
      });
      
      window.addEventListener('offline', function() {
        Swal.fire({
          icon: 'warning',
          title: 'Koneksi Terputus',
          text: 'Periksa koneksi internet Anda',
          timer: 2000,
          showConfirmButton: false,
          toast: true,
          position: 'top'
        });
      });
      
      // Handle visibility change - restart scanner when page becomes visible
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden && scannerScreen.classList.contains('d-none') === false) {
          if (!isScannerRunning) {
            setTimeout(startScanner, 1000);
          }
        }
      });
    });
    
    // Check cookie consent
    function checkCookieConsent() {
      const consent = localStorage.getItem(STORAGE_KEYS.COOKIE_CONSENT);
      
      if (consent === null) {
        // First time user, show cookie banner
        setTimeout(() => {
          cookieBanner.classList.remove('d-none');
        }, 1500);
      } else if (consent === 'accepted') {
        // User has accepted cookies, proceed with auto-login
        console.log('Cookie consent: accepted');
        initializeApp();
      } else {
        // User has declined cookies
        console.log('Cookie consent: declined');
        showCookieWarning();
        setTimeout(initializeScanner, 1000);
      }
    }
    
    // Accept cookies
    function acceptCookies() {
      localStorage.setItem(STORAGE_KEYS.COOKIE_CONSENT, 'accepted');
      cookieBanner.classList.add('d-none');
      Swal.fire({
        icon: 'success',
        title: 'Cookies Diterima',
        text: 'Data login akan disimpan di perangkat Anda',
        timer: 2000,
        showConfirmButton: false,
        toast: true,
        position: 'top'
      });
      initializeApp();
    }
    
    // Decline cookies
    function declineCookies() {
      localStorage.setItem(STORAGE_KEYS.COOKIE_CONSENT, 'declined');
      cookieBanner.classList.add('d-none');
      Swal.fire({
        icon: 'info',
        title: 'Cookies Ditolak',
        html: 'Anda perlu mendaftar setiap kali membuka aplikasi.<br><br>Data tidak akan disimpan di perangkat.',
        timer: 3000,
        showConfirmButton: false,
        toast: true,
        position: 'top'
      });
      initializeScanner();
    }
    
    // Show cookie warning
    function showCookieWarning() {
      Swal.fire({
        icon: 'warning',
        title: 'Cookies Dinonaktifkan',
        html: 'Anda telah menolak penyimpanan cookies.<br><br>Data login tidak akan disimpan di perangkat Anda.',
        confirmButtonText: 'OK',
        confirmButtonColor: '#1976d2'
      });
    }
    
    // Initialize application
    function initializeApp() {
      loadingText.textContent = 'Memeriksa data login tersimpan...';
      
      // Try to load user data from localStorage
      setTimeout(() => {
        loadUserData();
        
        if (userData && userData.nip && userData.deviceId) {
          // User data exists, validate with server
          validateStoredUserData();
        } else {
          // No stored data, proceed to scanner
          loadingText.textContent = 'Menyiapkan scanner...';
          setTimeout(initializeScanner, 500);
        }
      }, 1000);
    }
    
    // Validate stored user data with server
    function validateStoredUserData() {
      if (isAutoLoginAttempted) return;
      
      isAutoLoginAttempted = true;
      loadingText.textContent = 'Memvalidasi data login...';
      
      const deviceId = localStorage.getItem(STORAGE_KEYS.DEVICE_ID);
      
      google.script.run.withSuccessHandler((response) => {
        try {
          const result = JSON.parse(response);
          
          if (result.status === "registered") {
            // Stored data is valid, auto-login
            autoLoginSuccess(result);
          } else {
            // Stored data is invalid, clear and proceed
            clearInvalidUserData();
            initializeScanner();
          }
        } catch (e) {
          console.error("Error parsing validation response:", e);
          clearInvalidUserData();
          initializeScanner();
        }
      }).withFailureHandler((error) => {
        console.error("Validation failed:", error);
        // If validation fails, still try to use stored data
        if (userData && userData.nip) {
          updateUserInfo();
          initializeScanner();
        } else {
          clearInvalidUserData();
          initializeScanner();
        }
      }).checkRegistrationStatus(deviceId);
    }
    
    // Auto-login success
    function autoLoginSuccess(result) {
      // Update user data with server response
      userData = {
        nip: result.nip,
        nama: result.nama,
        deviceId: result.deviceId,
        jabatan: result.jabatan || ""
      };
      
      // Save to localStorage
      saveUserData();
      
      // Update UI
      updateUserInfo();
      
      // Show success message
      Swal.fire({
        icon: 'success',
        title: 'Login Otomatis Berhasil!',
        html: `Selamat datang kembali <strong>${result.nama}</strong>`,
        timer: 2000,
        showConfirmButton: false,
        toast: true,
        position: 'top'
      }).then(() => {
        initializeScanner();
      });
    }
    
    // Clear invalid user data
    function clearInvalidUserData() {
      userData = null;
      localStorage.removeItem(STORAGE_KEYS.USER_DATA);
      localStorage.removeItem(STORAGE_KEYS.LAST_LOGIN);
      logoutBtn.classList.add('d-none');
    }
    
    // Load user data from localStorage
    function loadUserData() {
      try {
        const storedData = localStorage.getItem(STORAGE_KEYS.USER_DATA);
        if (storedData) {
          userData = JSON.parse(storedData);
          
          // Check if data is still valid (not too old)
          const lastLogin = localStorage.getItem(STORAGE_KEYS.LAST_LOGIN);
          if (lastLogin) {
            const lastLoginDate = new Date(lastLogin);
            const now = new Date();
            const daysDiff = (now - lastLoginDate) / (1000 * 60 * 60 * 24);
            
            // Clear data if older than 30 days
            if (daysDiff > 30) {
              clearInvalidUserData();
              return;
            }
          }
          
          console.log('Loaded user data:', userData);
        }
      } catch (e) {
        console.error("Error loading user data:", e);
        clearInvalidUserData();
      }
    }
    
    // Save user data to localStorage
    function saveUserData() {
      if (!userData) return;
      
      try {
        localStorage.setItem(STORAGE_KEYS.USER_DATA, JSON.stringify(userData));
        localStorage.setItem(STORAGE_KEYS.LAST_LOGIN, new Date().toISOString());
        console.log('User data saved to localStorage');
      } catch (e) {
        console.error("Error saving user data:", e);
      }
    }
    
    // Update user info display
    function updateUserInfo() {
      if (userData && userData.nip && userData.nama) {
        userName.textContent = userData.nama;
        userNip.textContent = userData.nip;
        
        // Tampilkan jabatan jika ada
        if (userData.jabatan) {
          userStatus.innerHTML = `Jabatan: <span class="highlight">${userData.jabatan}</span> | Status: <span class="highlight" style="color: #4CAF50;">Terdaftar</span>`;
        } else {
          userStatus.innerHTML = 'Status: <span class="highlight" style="color: #4CAF50;">Terdaftar</span>';
        }
        
        userInfoCard.classList.remove('d-none');
        logoutBtn.classList.remove('d-none');
        
        // Update status absensi
        updateStatusAbsensi();
      } else {
        userName.textContent = "Nama Pegawai";
        userNip.textContent = "-";
        userStatus.innerHTML = 'Status: <span class="highlight" style="color: #FF9800;">Belum terdaftar</span>';
        userInfoCard.classList.add('d-none');
        logoutBtn.classList.add('d-none');
        
        // Sembunyikan badge jika tidak terdaftar
        sisaKesempatanBadge.classList.add('d-none');
        scannerMessage.classList.add('d-none');
      }
    }
    
    // Generate device ID
    function generateDeviceId() {
      let deviceId = localStorage.getItem(STORAGE_KEYS.DEVICE_ID);
      if (!deviceId) {
        // Generate unique device ID
        const timestamp = Date.now();
        const random = Math.floor(Math.random() * 1000000);
        const userAgentHash = navigator.userAgent.length % 10000;
        deviceId = `DEV_${timestamp}_${random}_${userAgentHash}`;
        localStorage.setItem(STORAGE_KEYS.DEVICE_ID, deviceId);
      }
      regDeviceId.value = deviceId;
      return deviceId;
    }
    
    // Logout user
    function logoutUser() {
      Swal.fire({
        title: 'Konfirmasi Logout',
        html: `Apakah Anda yakin ingin logout?<br><br>
               <small>Data login akan dihapus dari perangkat ini.</small>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ya, Logout',
        confirmButtonColor: '#d33',
        cancelButtonText: 'Batal',
        cancelButtonColor: '#1976d2'
      }).then((result) => {
        if (result.isConfirmed) {
          // Clear user data
          clearInvalidUserData();
          
          // Stop scanner
          stopScanner();
          
          // Update UI
          updateUserInfo();
          
          // Show message
          Swal.fire({
            icon: 'success',
            title: 'Logout Berhasil',
            text: 'Data login telah dihapus dari perangkat',
            timer: 2000,
            showConfirmButton: false,
            toast: true,
            position: 'top'
          }).then(() => {
            // Refresh scanner
            setTimeout(() => {
              startScanner();
            }, 500);
          });
        }
      });
    }
    
    // Update date and time display
    function updateDateTime() {
      const now = new Date();
      const dateStr = now.toLocaleDateString('id-ID', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      const timeStr = now.toLocaleTimeString('id-ID', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      
      datetimeElement.textContent = `${dateStr} | ${timeStr}`;
      currentTime.textContent = now.toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'});
      currentDate.textContent = now.toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'});
    }
    
    // Check location status
    function checkLocationStatus() {
      if (navigator.geolocation) {
        locationStatus.textContent = "Aktif";
        locationStatus.style.color = "var(--success)";
        locationStatus.style.fontWeight = "700";
      } else {
        locationStatus.textContent = "Nonaktif";
        locationStatus.style.color = "var(--danger)";
        locationStatus.style.fontWeight = "700";
      }
    }
    
    // Show scanner screen
    function showScannerScreen() {
      loadingScreen.classList.add('d-none');
      registerScreen.classList.add('d-none');
      scannerScreen.classList.remove('d-none');
      
      // Push state to history
      history.pushState({ screen: 'scanner' }, '', '#scanner');
      
      // Restart scanner
      setTimeout(() => {
        if (!isScannerRunning) {
          startScanner();
        }
      }, 500);
    }
    
    // Show registration screen
    function showRegistrationScreen() {
      scannerScreen.classList.add('d-none');
      registerScreen.classList.remove('d-none');
      
      // Push state to history
      history.pushState({ screen: 'register' }, '', '#register');
      
      // Stop scanner
      stopScanner();
      
      // Focus ke input NIP
      setTimeout(() => {
        regNip.focus();
      }, 300);
    }
    
    // Refresh scanner
    function refreshScanner() {
      stopScanner();
      
      Swal.fire({
        title: 'Merefresh Scanner...',
        allowOutsideClick: false,
        timer: 1000,
        timerProgressBar: true,
        didOpen: () => {
          Swal.showLoading();
        }
      }).then(() => {
        startScanner();
        Swal.fire({
          icon: 'success',
          title: 'Scanner Siap!',
          text: 'QR Code scanner telah direfresh',
          timer: 1500,
          showConfirmButton: false,
          toast: true,
          position: 'top'
        });
      });
    }
    
    // Initialize QR scanner
    function initializeScanner() {
      loadingText.textContent = 'Menyiapkan scanner QR Code...';
      
      // Check if Html5Qrcode is available
      if (typeof Html5Qrcode === 'undefined') {
        Swal.fire({
          icon: 'error',
          title: 'Library Tidak Ditemukan',
          html: 'Library QR Scanner gagal dimuat.<br><br>Periksa koneksi internet Anda.',
          confirmButtonText: 'OK',
          confirmButtonColor: '#1976d2'
        });
        return;
      }
      
      // Initialize the scanner
      try {
        html5QrCode = new Html5Qrcode("reader");
        console.log("Scanner initialized successfully");
      } catch (e) {
        console.error("Failed to initialize scanner:", e);
        Swal.fire({
          icon: 'error',
          title: 'Gagal Inisialisasi Scanner',
          text: 'Terjadi kesalahan saat memulai scanner QR Code',
          confirmButtonText: 'OK',
          confirmButtonColor: '#1976d2'
        });
        return;
      }
      
      // Show scanner screen
      showScannerScreen();
    }
    
    // Start QR scanner
    function startScanner() {
      if (!html5QrCode) {
        console.error("Scanner not initialized");
        return;
      }
      
      // Check for camera support
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        Swal.fire({
          icon: 'error',
          title: 'Kamera Tidak Didukung',
          html: 'Browser Anda tidak mendukung akses kamera.<br><br>Gunakan browser modern seperti Chrome, Firefox, atau Safari.',
          confirmButtonText: 'OK',
          confirmButtonColor: '#1976d2'
        });
        return;
      }
      
      // Get available cameras
      Html5Qrcode.getCameras().then(devices => {
        if (!devices || devices.length === 0) {
          Swal.fire({
            icon: 'warning',
            title: 'Kamera Tidak Ditemukan',
            html: 'Tidak ada kamera yang terdeteksi pada perangkat Anda.<br><br>Pastikan kamera tersedia dan tidak sedang digunakan aplikasi lain.',
            confirmButtonText: 'OK',
            confirmButtonColor: '#1976d2'
          });
          return;
        }
        
        // Use back camera if available, otherwise use first camera
        let cameraId = devices[0].id;
        let cameraLabel = devices[0].label;
        
        // Try to find back camera
        const backCamera = devices.find(device => {
          const label = device.label.toLowerCase();
          return label.includes('back') || label.includes('rear') || label.includes('belakang');
        });
        
        if (backCamera) {
          cameraId = backCamera.id;
          cameraLabel = backCamera.label;
        }
        
        console.log(`Using camera: ${cameraLabel}`);
        
        // Calculate QR box size for mobile
        const qrboxSize = Math.min(window.innerWidth * 0.9, 750);
        
        // Start scanning
        html5QrCode.start(
          cameraId,
          {
            fps: 20,
            qrbox: { 
              width: qrboxSize, 
              height: qrboxSize 
            },
            aspectRatio: 1.0,
            disableFlip: false,
            focusMode: "continuous",
            experimentalFeatures: {
              useBarCodeDetectorIfSupported: true
            },
            showTorchButtonIfSupported: true,
            showZoomSliderIfSupported: true
          },
          (decodedText) => {
            onScanSuccess(decodedText);
          },
          (errorMessage) => {
            if (!errorMessage.includes("NotFoundException")) {
              console.log("Scan debug:", errorMessage);
            }
          }
        ).then(() => {
          isScannerRunning = true;
          console.log("Scanner started successfully");
          
          // Hide loading screen if still showing
          loadingScreen.classList.add('d-none');
          
        }).catch(err => {
          console.error("Failed to start scanner with specific camera:", err);
          
          // Fallback: try with environment-facing mode
          Swal.fire({
            title: 'Menyiapkan Scanner...',
            allowOutsideClick: false,
            timer: 1000,
            didOpen: () => {
              Swal.showLoading();
            }
          }).then(() => {
            html5QrCode.start(
              { facingMode: "environment" },
              {
                fps: 15,
                qrbox: { 
                  width: qrboxSize, 
                  height: qrboxSize 
                },
                aspectRatio: 1.0
              },
              (decodedText) => {
                onScanSuccess(decodedText);
              },
              (errorMessage) => {
                console.log("Scan error:", errorMessage);
              }
            ).then(() => {
              isScannerRunning = true;
              console.log("Scanner started with environment mode");
            }).catch(finalErr => {
              console.error("Final scanner error:", finalErr);
              
              let errorMsg = "Gagal mengakses kamera. ";
              if (finalErr.message.includes("Permission")) {
                errorMsg += "Izinkan akses kamera di pengaturan browser.";
              } else if (finalErr.message.includes("NotFound")) {
                errorMsg += "Kamera tidak ditemukan.";
              } else {
                errorMsg += finalErr.message;
              }
              
              Swal.fire({
                icon: 'error',
                title: 'Gagal Mengakses Kamera',
                html: `${errorMsg}<br><br>
                       <small>1. Pastikan izin kamera diaktifkan<br>
                       2. Periksa jika kamera sedang digunakan aplikasi lain<br>
                       3. Coba refresh halaman atau gunakan browser lain</small>`,
                confirmButtonText: 'OK',
                confirmButtonColor: '#1976d2'
              });
            });
          });
        });
        
      }).catch(err => {
        console.error("Error getting cameras:", err);
        Swal.fire({
          icon: 'error',
          title: 'Akses Kamera Ditolak',
          html: `Izinkan akses kamera di pengaturan browser untuk menggunakan scanner.<br><br>
                 <small>Klik ikon gembok/kamera di address bar browser untuk mengatur izin.</small>`,
          confirmButtonText: 'OK',
          confirmButtonColor: '#1976d2'
        });
      });
    }
    
    // Stop scanner
    function stopScanner() {
      if (html5QrCode && isScannerRunning) {
        try {
          html5QrCode.stop();
          isScannerRunning = false;
        } catch (e) {
          console.error("Error stopping scanner:", e);
        }
      }
    }
    
    // Handle successful scan
    function onScanSuccess(decodedText) {
      // Stop scanner temporarily
      stopScanner();
      
      console.log("QR Code detected:", decodedText);
      
      // Play scan sound
      playScanSound();
      
      // Determine apel type from QR code
      let jenis = "";
      if (decodedText.includes("APEL_PAGI") || decodedText.toLowerCase().includes("pagi")) {
        jenis = "pagi";
      } else if (decodedText.includes("APEL_SORE") || decodedText.toLowerCase().includes("sore")) {
        jenis = "sore";
      }
      
      if (!jenis) {
        Swal.fire({
          icon: 'error',
          title: 'QR Code Tidak Valid',
          html: 'QR Code ini bukan untuk absensi apel.<br><br>Gunakan QR Code resmi dari Lapas Baubau.',
          confirmButtonText: 'OK',
          confirmButtonColor: '#1976d2'
        }).then(() => {
          startScanner();
        });
        return;
      }
      
      currentApelType = jenis;
      
      // Show scanning success feedback
      Swal.fire({
        icon: 'success',
        title: 'QR Code Berhasil Discan!',
        html: `<div style="text-align: center;">
                <div style="font-size: 3.5rem; color: #4CAF50; margin: 15px 0;">
                  <i class="fas fa-check-circle"></i>
                </div>
                <h4 style="color: #2e7d32; font-size: 1.5rem;">Apel ${jenis === 'pagi' ? 'Pagi' : 'Sore'}</h4>
                <p style="font-size: 1.1rem;">Memproses absensi...</p>
              </div>`,
        timer: 1500,
        showConfirmButton: false,
        background: '#f8f9fa'
      }).then(() => {
        // Check if user is registered
        if (!userData || !userData.nip || !userData.deviceId) {
          // Cek apakah device sudah terdaftar di sistem
          const deviceId = localStorage.getItem(STORAGE_KEYS.DEVICE_ID);
          
          Swal.fire({
            title: 'Memeriksa Status Akun...',
            html: '<div style="text-align: center;">' +
                  '<div class="spinner" style="width: 50px; height: 50px; margin: 0 auto 20px;"></div>' +
                  '<p style="font-size: 1.1rem;">Memeriksa apakah perangkat Anda sudah terdaftar...</p>' +
                  '</div>',
            allowOutsideClick: false,
            showConfirmButton: false,
            background: '#f8f9fa'
          });
          
          google.script.run.withSuccessHandler((response) => {
            Swal.close();
            
            let result;
            try {
              result = JSON.parse(response);
            } catch (e) {
              console.error("Error parsing response:", e);
              promptManualRegistration(jenis);
              return;
            }
            
            if (result.status === "registered") {
              // Auto-login dengan data dari server
              userData = {
                nip: result.nip,
                nama: result.nama,
                deviceId: deviceId,
                jabatan: result.jabatan || ""
              };
              
              saveUserData();
              updateUserInfo();
              
              // Lanjutkan dengan absensi
              proceedWithAttendance(jenis);
              
            } else {
              // Perangkat belum terdaftar, tampilkan form
              promptManualRegistration(jenis);
            }
            
          }).withFailureHandler((error) => {
            Swal.close();
            promptManualRegistration(jenis);
          }).checkRegistrationStatus(deviceId);
          
          return;
        }
        
        // User is registered, proceed with attendance
        proceedWithAttendance(jenis);
      });
    }
    
    // Fungsi untuk prompt registrasi manual
    function promptManualRegistration(jenis) {
      Swal.fire({
        icon: 'info',
        title: 'Perangkat Belum Terdaftar',
        html: `<div style="text-align: center;">
                 <p style="font-size: 1.1rem;">Perangkat Anda belum terdaftar di sistem.</p>
                 <div style="background: #fff3e0; padding: 20px; border-radius: 12px; margin: 20px 0; border-left: 5px solid #FF9800;">
                   <p style="font-size: 1.2rem;"><i class="fas fa-qrcode"></i> QR Code <strong>${jenis.toUpperCase()}</strong> berhasil discan</p>
                   <p style="font-size: 1rem;">Silakan daftarkan perangkat Anda terlebih dahulu</p>
                 </div>
               </div>`,
        confirmButtonText: 'Daftar Sekarang',
        confirmButtonColor: '#1976d2',
        showCancelButton: true,
        cancelButtonText: 'Nanti Saja',
        background: '#f8f9fa'
      }).then((result) => {
        if (result.isConfirmed) {
          showRegistrationScreen();
        } else {
          startScanner();
        }
      });
    }
    
    // Proceed with attendance submission
    function proceedWithAttendance(jenis) {
      Swal.fire({
        title: 'Memproses Absensi',
        html: '<div style="text-align: center;">' +
              '<div class="spinner" style="width: 50px; height: 50px; margin: 0 auto 20px;"></div>' +
              '<p style="font-size: 1.1rem;">Mengambil lokasi Anda...</p>' +
              '</div>',
        allowOutsideClick: false,
        showConfirmButton: false,
        background: '#f8f9fa'
      });
      
      // Get current location
      navigator.geolocation.getCurrentPosition(
        (position) => {
          submitAttendance(position.coords.latitude, position.coords.longitude, jenis);
        },
        (error) => {
          Swal.close();
          
          let errorMessage = "Gagal mengakses lokasi";
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMessage = "Izin lokasi ditolak. Aktifkan lokasi di pengaturan perangkat.";
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage = "Informasi lokasi tidak tersedia. Pastikan GPS aktif.";
              break;
            case error.TIMEOUT:
              errorMessage = "Permintaan lokasi timeout. Periksa koneksi internet.";
              break;
          }
          
          Swal.fire({
            icon: 'error',
            title: errorMessage,
            html: `Izinkan akses lokasi untuk melanjutkan absensi.<br><br>
                   <small>Absensi memerlukan verifikasi lokasi untuk validasi kehadiran.</small>`,
            confirmButtonText: 'OK',
            confirmButtonColor: '#1976d2'
          }).then(() => {
            startScanner();
          });
        },
        { 
          timeout: 15000, 
          enableHighAccuracy: true,
          maximumAge: 0
        }
      );
    }
    
    // Submit attendance to server
    function submitAttendance(lat, lon, jenis) {
      Swal.update({
        title: 'Mengirim Absensi',
        html: '<div style="text-align: center;">' +
              '<div class="spinner" style="width: 50px; height: 50px; margin: 0 auto 20px;"></div>' +
              '<p style="font-size: 1.1rem;">Sedang mengirim data absensi ke server...</p>' +
              '</div>'
      });
      
      google.script.run.withSuccessHandler((response) => {
        Swal.close();
        
        if (response.status === "success") {
          // Play success sound
          playSuccessSound();
          
          Swal.fire({
            icon: 'success',
            title: 'Absensi Berhasil!',
            html: `<div style="text-align: center;">
                     <div style="font-size: 4.5rem; color: #4CAF50; margin-bottom: 20px;">
                       <i class="fas fa-check-circle"></i>
                     </div>
                     <h3 style="color: #2e7d32; font-size: 1.6rem;">${response.message}</h3>
                     <div style="background: #f0f8ff; padding: 20px; border-radius: 12px; margin: 20px 0; text-align: left; font-size: 1.1rem;">
                       <p><strong>Jenis Apel:</strong> ${jenis === 'pagi' ? 'Apel Pagi' : 'Apel Sore'}</p>
                       <p><strong>Waktu:</strong> ${new Date().toLocaleTimeString('id-ID')}</p>
                       <p><strong>Tanggal:</strong> ${new Date().toLocaleDateString('id-ID')}</p>
                     </div>
                     <p style="font-size: 1rem; color: #666;">Absensi telah tercatat di sistem</p>
                   </div>`,
            confirmButtonText: 'Selesai',
            confirmButtonColor: '#4CAF50',
            allowOutsideClick: false,
            width: isMobileDevice() ? '90%' : '500px',
            background: '#f8f9fa'
          }).then(() => {
            // Update status absensi
            updateStatusAbsensi();
            
            // Restart scanner
            startScanner();
          });
        } else if (response.message.includes("DEVICE")) {
          // Device not registered or reset
          Swal.fire({
            icon: 'warning',
            title: 'Perangkat Tidak Terdaftar',
            html: `<p style="font-size: 1.1rem;">${response.message}</p>
                   <small>Perangkat Anda perlu didaftarkan ulang ke sistem.</small>`,
            confirmButtonText: 'Daftar Ulang',
            confirmButtonColor: '#1976d2'
          }).then(() => {
            // Clear user data and show registration
            clearInvalidUserData();
            updateUserInfo();
            showRegistrationScreen();
          });
        } else {
          // Other errors
          Swal.fire({
            icon: 'error',
            title: 'Absensi Gagal',
            html: `<p style="font-size: 1.1rem;">${response.message}</p>
                   <small>Silakan scan ulang QR Code jika sudah sesuai ketentuan waktu dan lokasi.</small>`,
            confirmButtonText: 'OK',
            confirmButtonColor: '#1976d2'
          }).then(() => {
            startScanner();
          });
        }
        
      }).withFailureHandler((error) => {
        Swal.close();
        console.error("Server error:", error);
        Swal.fire({
          icon: 'error',
          title: 'Kesalahan Server',
          html: `Terjadi kesalahan saat mengirim data.<br><br>
                 <small>Periksa koneksi internet Anda dan coba lagi.</small>`,
          confirmButtonText: 'OK',
          confirmButtonColor: '#1976d2'
        }).then(() => {
          startScanner();
        });
        
      }).submitAbsen(
        userData.nip,
        userData.deviceId,
        jenis,
        lat,
        lon
      );
    }
    
    // Play scan sound
    function playScanSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 1200;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.15);
      } catch (e) {
        // Sound not supported, ignore
      }
    }
    
    // Play success sound
    function playSuccessSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Play a pleasant success tone
        const oscillator1 = audioContext.createOscillator();
        const oscillator2 = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator1.connect(gainNode);
        oscillator2.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator1.frequency.value = 523.25; // C5
        oscillator2.frequency.value = 659.25; // E5
        oscillator1.type = 'sine';
        oscillator2.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.6);
        
        oscillator1.start(audioContext.currentTime);
        oscillator2.start(audioContext.currentTime);
        oscillator1.stop(audioContext.currentTime + 0.6);
        oscillator2.stop(audioContext.currentTime + 0.6);
      } catch (e) {
        // Sound not supported, ignore
      }
    }
    
    // Submit registration
    function submitRegistration() {
      const nip = regNip.value.trim();
      
      // Validasi input
      if (!nip) {
        Swal.fire({
          icon: 'warning',
          title: 'NIP Kosong',
          text: 'Masukkan NIP terlebih dahulu',
          confirmButtonText: 'OK',
          confirmButtonColor: '#1976d2'
        });
        regNip.focus();
        return;
      }
      
      // Format NIP hanya angka, minimal 8 digit
      if (!/^\d+$/.test(nip)) {
        Swal.fire({
          icon: 'warning',
          title: 'Format NIP Tidak Valid',
          html: 'NIP hanya boleh berisi angka.<br><br>Contoh: 197001012000011001',
          confirmButtonText: 'OK',
          confirmButtonColor: '#1976d2'
        });
        regNip.focus();
        regNip.select();
        return;
      }
      
      if (nip.length < 8 || nip.length > 20) {
        Swal.fire({
          icon: 'warning',
          title: 'Panjang NIP Tidak Sesuai',
          html: 'NIP harus antara 8-20 digit.<br><br>Contoh: 197001012000011001',
          confirmButtonText: 'OK',
          confirmButtonColor: '#1976d2'
        });
        regNip.focus();
        regNip.select();
        return;
      }
      
      const deviceId = regDeviceId.value;
      
      // Tampilkan loading dengan informasi NIP
      Swal.fire({
        title: 'Memeriksa Data Pegawai...',
        html: `<div style="text-align: center;">
                <div class="spinner" style="width: 50px; height: 50px; margin: 0 auto 20px;"></div>
                <p style="font-size: 1.1rem;">Memeriksa NIP: <strong>${nip}</strong></p>
                <small>Sedang memvalidasi data di sistem...</small>
               </div>`,
        allowOutsideClick: false,
        showConfirmButton: false,
        background: '#f8f9fa'
      });
      
      // Panggil fungsi cek duplikasi
      google.script.run.withSuccessHandler((response) => {
        Swal.close();
        
        // Parse response JSON
        let result;
        try {
          result = JSON.parse(response);
        } catch (e) {
          console.error("Error parsing response:", e);
          Swal.fire({
            icon: 'error',
            title: 'Response Error',
            text: 'Terjadi kesalahan dalam memproses response',
            confirmButtonText: 'OK',
            confirmButtonColor: '#1976d2'
          });
          return;
        }
        
        // Handle berbagai status response
        switch(result.status) {
          case "duplicate":
            handleDuplicateRegistration(result);
            break;
            
          case "available":
            handleAvailableRegistration(nip, deviceId, result);
            break;
            
          case "device_duplicate":
            Swal.fire({
              icon: 'error',
              title: 'Perangkat Sudah Terdaftar',
              html: `<div style="text-align: center;">
                      <p style="font-size: 1.1rem;">Perangkat ini sudah terdaftar atas nama:</p>
                      <div style="background: #ffebee; padding: 20px; border-radius: 12px; margin: 20px 0; border-left: 5px solid #f44336;">
                        <p style="font-size: 1.2rem; font-weight: bold;">${result.existingNama}</p>
                        <p>NIP: ${result.existingNip}</p>
                      </div>
                      <p style="color: #f44336; font-size: 1rem;">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Satu perangkat hanya untuk satu akun
                      </p>
                     </div>`,
              confirmButtonText: 'OK',
              confirmButtonColor: '#1976d2'
            });
            break;
            
          case "nip_duplicate":
            Swal.fire({
              icon: 'warning',
              title: 'NIP Sudah Terdaftar',
              html: `<div style="text-align: center;">
                      <p style="font-size: 1.1rem;">NIP <strong>${nip}</strong> sudah terdaftar dengan perangkat lain</p>
                      <div style="background: #fff3e0; padding: 20px; border-radius: 12px; margin: 20px 0; border-left: 5px solid #FF9800;">
                        <p>Atas nama: <strong>${result.existingNama}</strong></p>
                        <p>Device ID: ${result.existingDevice.substring(0, 20)}...</p>
                      </div>
                      <p style="font-size: 1rem;">
                        Hubungi admin jika ini adalah perangkat baru Anda
                      </p>
                     </div>`,
              confirmButtonText: 'Hubungi Admin',
              confirmButtonColor: '#1976d2',
              showCancelButton: true,
              cancelButtonText: 'OK'
            }).then((result) => {
              if (result.isConfirmed) {
                window.open('https://wa.me/6281234567890?text=Halo%20Admin,%20saya%20perlu%20bantuan%20reset%20perangkat%20untuk%20NIP%20' + nip, '_blank');
              }
            });
            break;
            
          case "error":
            Swal.fire({
              icon: 'error',
              title: 'Validasi Gagal',
              html: `<p style="font-size: 1.1rem;">${result.message}</p>
                     <small>Pastikan NIP Anda benar dan terdaftar di sistem</small>`,
              confirmButtonText: 'OK',
              confirmButtonColor: '#1976d2'
            });
            break;
            
          default:
            Swal.fire({
              icon: 'error',
              title: 'Status Tidak Dikenali',
              text: 'Terjadi kesalahan tidak terduga',
              confirmButtonText: 'OK',
              confirmButtonColor: '#1976d2'
            });
        }
        
      }).withFailureHandler((error) => {
        Swal.close();
        Swal.fire({
          icon: 'error',
          title: 'Koneksi Gagal',
          html: `Tidak dapat terhubung ke server.<br><br>
                 <small>Periksa koneksi internet Anda dan coba lagi.</small>`,
          confirmButtonText: 'OK',
          confirmButtonColor: '#1976d2'
        });
      }).checkDuplicateRegistration(nip, deviceId);
    }
    
    // Fungsi untuk handle registrasi duplicate (sudah terdaftar)
    function handleDuplicateRegistration(result) {
      // Simpan data user ke localStorage
      userData = {
        nip: result.nip,
        nama: result.nama,
        deviceId: result.deviceId,
        jabatan: result.jabatan || ""
      };
      
      saveUserData();
      updateUserInfo();
      
      // Tampilkan informasi akun yang ditemukan
      Swal.fire({
        icon: 'success',
        title: 'Akun Ditemukan!',
        html: `<div style="text-align: center;">
                 <div style="font-size: 4.5rem; color: #4CAF50; margin-bottom: 20px;">
                   <i class="fas fa-user-check"></i>
                 </div>
                 <h3 style="color: #2e7d32; font-size: 1.6rem;">Selamat Datang Kembali!</h3>
                 <div style="background: #f0f8ff; padding: 25px; border-radius: 12px; margin: 20px 0; text-align: left; font-size: 1.1rem;">
                   <p><strong>Nama:</strong> ${result.nama}</p>
                   <p><strong>NIP:</strong> ${result.nip}</p>
                   ${result.jabatan ? `<p><strong>Jabatan:</strong> ${result.jabatan}</p>` : ''}
                   <p><strong>Status:</strong> <span style="color: #4CAF50; font-weight: bold;">Sudah Terdaftar</span></p>
                 </div>
                 <p style="font-size: 1rem; color: #666;">
                   Anda akan langsung dialihkan ke scanner...
                 </p>
               </div>`,
        timer: 3000,
        timerProgressBar: true,
        showConfirmButton: false,
        background: '#f8f9fa'
      }).then(() => {
        showScannerScreen();
      });
    }
    
    // Fungsi untuk handle registrasi baru
    function handleAvailableRegistration(nip, deviceId, result) {
      // Tampilkan konfirmasi data pegawai
      Swal.fire({
        icon: 'info',
        title: 'Konfirmasi Data Pegawai',
        html: `<div style="text-align: center;">
                 <div style="font-size: 3.5rem; color: #2196F3; margin-bottom: 20px;">
                   <i class="fas fa-user-tie"></i>
                 </div>
                 <p style="font-size: 1.2rem;">Data ditemukan di sistem:</p>
                 <div style="background: #e8f5e9; padding: 25px; border-radius: 12px; margin: 20px 0; text-align: left; font-size: 1.1rem;">
                   <p><strong>Nama:</strong> ${result.nama}</p>
                   <p><strong>NIP:</strong> ${nip}</p>
                   ${result.jabatan ? `<p><strong>Jabatan:</strong> ${result.jabatan}</p>` : ''}
                 </div>
                 <p style="font-size: 1.1rem;">Apakah data di atas sudah benar?</p>
               </div>`,
        showCancelButton: true,
        confirmButtonText: 'Ya, Data Benar',
        confirmButtonColor: '#4CAF50',
        cancelButtonText: 'Periksa Kembali',
        cancelButtonColor: '#757575',
        reverseButtons: true,
        background: '#f8f9fa',
        width: isMobileDevice() ? '90%' : '500px'
      }).then((confirmation) => {
        if (confirmation.isConfirmed) {
          proceedWithRegistration(nip, deviceId, result);
        } else {
          regNip.focus();
          regNip.select();
        }
      });
    }
    
    // Fungsi untuk melanjutkan pendaftaran baru
    function proceedWithRegistration(nip, deviceId, preCheckResult) {
      Swal.fire({
        title: 'Mendaftarkan Akun',
        html: `<div style="text-align: center;">
                <div class="spinner" style="width: 50px; height: 50px; margin: 0 auto 20px;"></div>
                <p style="font-size: 1.1rem;">Mendaftarkan: <strong>${preCheckResult.nama}</strong></p>
                <small>Mohon tunggu beberapa saat...</small>
               </div>`,
        allowOutsideClick: false,
        showConfirmButton: false,
        background: '#f8f9fa'
      });
      
      // Kirim data pendaftaran ke server
      google.script.run.withSuccessHandler((response) => {
        Swal.close();
        
        let result;
        try {
          result = JSON.parse(response);
        } catch (e) {
          console.error("Error parsing response:", e);
          Swal.fire({
            icon: 'error',
            title: 'Response Error',
            text: 'Terjadi kesalahan dalam memproses response',
            confirmButtonText: 'OK',
            confirmButtonColor: '#1976d2'
          });
          return;
        }
        
        if (result.status === "ok") {
          // Simpan data user ke localStorage
          userData = {
            nip: result.nip,
            nama: result.nama,
            deviceId: deviceId,
            jabatan: result.jabatan || ""
          };
          
          saveUserData();
          updateUserInfo();
          
          // Tampilkan sukses
          Swal.fire({
            icon: 'success',
            title: 'Pendaftaran Berhasil!',
            html: `<div style="text-align: center;">
                     <div style="font-size: 4.5rem; color: #4CAF50; margin-bottom: 20px;">
                       <i class="fas fa-user-check"></i>
                     </div>
                     <h3 style="color: #2e7d32; font-size: 1.6rem;">Selamat Bergabung!</h3>
                     <div style="background: #f0f8ff; padding: 25px; border-radius: 12px; margin: 20px 0; text-align: left; font-size: 1.1rem;">
                       <p><strong>Nama:</strong> ${result.nama}</p>
                       <p><strong>NIP:</strong> ${result.nip}</p>
                       ${result.jabatan ? `<p><strong>Jabatan:</strong> ${result.jabatan}</p>` : ''}
                       <p><strong>Status:</strong> <span style="color: #4CAF50; font-weight: bold;">AKTIF</span></p>
                       <p><strong>Tanggal Daftar:</strong> ${new Date().toLocaleDateString('id-ID')}</p>
                     </div>
                     <p style="font-size: 1rem; color: #666;">
                       Akun Anda sudah siap digunakan untuk absensi
                     </p>
                   </div>`,
            confirmButtonText: 'Mulai Absensi',
            confirmButtonColor: '#4CAF50',
            width: isMobileDevice() ? '90%' : '500px',
            background: '#f8f9fa'
          }).then(() => {
            showScannerScreen();
            
            // Jika ada apel yang pending, lanjutkan
            if (currentApelType) {
              setTimeout(() => {
                proceedWithAttendance(currentApelType);
              }, 1500);
            }
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Pendaftaran Gagal',
            html: `<p style="font-size: 1.1rem;">${result.message}</p>
                   <small>Silakan coba lagi atau hubungi admin</small>`,
            confirmButtonText: 'OK',
            confirmButtonColor: '#1976d2'
          });
        }
      }).withFailureHandler((error) => {
        Swal.close();
        Swal.fire({
          icon: 'error',
          title: 'Kesalahan Server',
          html: `Terjadi kesalahan saat mendaftar.<br><br>
                 <small>Periksa koneksi internet Anda dan coba lagi.</small>`,
          confirmButtonText: 'OK',
          confirmButtonColor: '#1976d2'
        });
      }).signupUser(nip, deviceId);
    }
    
    // Update status absensi
    function updateStatusAbsensi() {
      if (!userData || !userData.nip) return;
      
      google.script.run.withSuccessHandler((status) => {
        // Parse status
        let result;
        try {
          result = JSON.parse(status);
        } catch (e) {
          console.error("Error parsing status:", e);
          return;
        }
        
        // Update badge sisa kesempatan
        if (result.sisaKesempatan !== undefined) {
          sisaKesempatanCount.textContent = result.sisaKesempatan;
          
          if (result.sisaKesempatan > 0) {
            sisaKesempatanBadge.style.background = 'var(--success)';
            sisaKesempatanBadge.classList.remove('d-none');
          } else if (result.sisaKesempatan === 0) {
            sisaKesempatanBadge.style.background = 'var(--danger)';
            sisaKesempatanBadge.classList.remove('d-none');
          }
        }
        
        // Update scanner message
        if (result.totalAbsen >= 2) {
          scannerMessage.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="font-size: 1.8rem; color: var(--success);">
                <i class="fas fa-check-circle"></i>
              </div>
              <div>
                <p style="margin: 0; color: var(--success); font-weight: bold; font-size: 1.1rem;">
                  Anda sudah absen 2 kali hari ini (lengkap)
                </p>
                <p style="margin: 5px 0 0 0; color: var(--gray); font-size: 0.95rem;">
                  Pagi: ${result.waktuPagi || '-'} | Sore: ${result.waktuSore || '-'}
                </p>
              </div>
            </div>
          `;
          scannerMessage.classList.remove('d-none');
        } else {
          scannerMessage.classList.add('d-none');
        }
        
      }).cekStatusAbsensiHariIni(userData.nip);
    }
    
    // Detect mobile device
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    // Adjust UI for mobile
    function adjustForMobile() {
      if (isMobileDevice()) {
        console.log("Mobile device detected - optimizing UI");
        
        // Make buttons even larger on small phones
        if (window.innerWidth <= 360) {
          const buttons = document.querySelectorAll('.btn');
          buttons.forEach(btn => {
            btn.style.minHeight = '62px';
            btn.style.fontSize = '1.15rem';
          });
        }
        
        // Adjust scanner area height based on screen
        const scannerArea = document.querySelector('.scanner-area');
        if (scannerArea && window.innerHeight < 700) {
          scannerArea.style.minHeight = '55vh';
        }
      }
    }
    
    // PWA Installation Prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // Show install prompt after delay
      setTimeout(() => {
        if (deferredPrompt && !localStorage.getItem('pwaPromptShown')) {
          Swal.fire({
            title: 'Pasang Aplikasi',
            html: `<div style="text-align: center;">
                     <div style="font-size: 3.5rem; color: #1976d2; margin-bottom: 15px;">
                       <i class="fas fa-mobile-alt"></i>
                     </div>
                     <p style="font-size: 1.2rem;">Pasang aplikasi Absensi Apel ke home screen untuk akses lebih mudah?</p>
                     <small style="font-size: 1rem;">Aplikasi dapat digunakan seperti aplikasi native tanpa perlu membuka browser.</small>
                   </div>`,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'Pasang Sekarang',
            confirmButtonColor: '#1976d2',
            cancelButtonText: 'Nanti Saja',
            width: isMobileDevice() ? '90%' : '400px',
            background: '#f8f9fa'
          }).then((result) => {
            if (result.isConfirmed && deferredPrompt) {
              deferredPrompt.prompt();
              deferredPrompt.userChoice.then((choiceResult) => {
                localStorage.setItem('pwaPromptShown', 'true');
                if (choiceResult.outcome === 'accepted') {
                  console.log('User installed the PWA');
                }
                deferredPrompt = null;
              });
            } else {
              localStorage.setItem('pwaPromptShown', 'true');
            }
          });
        }
      }, 5000);
    });
    
    // Handle resize for better mobile experience
    let resizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(function() {
        // Re-adjust for mobile on resize
        adjustForMobile();
        
        // Restart scanner if needed
        if (!registerScreen.classList.contains('d-none') === false && isScannerRunning) {
          stopScanner();
          setTimeout(startScanner, 500);
        }
      }, 250);
    });
  </script>
  <!-- Tambahkan ini SEBELUM </body> -->
<script>
  // ====== GAS DEPLOYMENT CONFIG ======
  // Ganti dengan URL Web Apps Anda setelah deploy
  const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw9z7MUv6VXZnaWFO-ek82gJKmIcL8VGajH-Kx10wRkBFmk76VbsD5WxqFdUxop20x6/exec';
  
  // ====== AJAX HANDLER UNTUK GAS ======
  function callGoogleScript(functionName, params = {}) {
    return new Promise((resolve, reject) => {
      // Tambahkan timestamp untuk menghindari cache
      params._t = new Date().getTime();
      
      // Buat form data
      const formData = new FormData();
      Object.keys(params).forEach(key => {
        formData.append(key, params[key]);
      });
      
      // Kirim request ke GAS
      fetch(`${GAS_WEB_APP_URL}?fn=${functionName}`, {
        method: 'POST',
        mode: 'no-cors', // Penting untuk Google Apps Script
        body: formData
      })
      .then(response => {
        // Karena 'no-cors', kita tidak bisa membaca response langsung
        // Kita perlu menggunakan Google Apps Script dengan metode GET
        callGoogleScriptGet(functionName, params)
          .then(resolve)
          .catch(reject);
      })
      .catch(reject);
    });
  }
  
  // Alternatif menggunakan GET (lebih reliable untuk GAS)
  function callGoogleScriptGet(functionName, params = {}) {
    return new Promise((resolve, reject) => {
      // Build URL dengan parameters
      const urlParams = new URLSearchParams();
      urlParams.append('fn', functionName);
      Object.keys(params).forEach(key => {
        urlParams.append(key, params[key]);
      });
      
      fetch(`${GAS_WEB_APP_URL}?${urlParams.toString()}`, {
        method: 'GET',
        mode: 'cors',
        credentials: 'omit'
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.text();
      })
      .then(text => {
        try {
          const data = JSON.parse(text);
          resolve(data);
        } catch (e) {
          // Jika response bukan JSON, return sebagai text
          resolve(text);
        }
      })
      .catch(reject);
    });
  }
  
  // ====== REPLACE google.script.run CALLS ======
  // Simpan fungsi asli untuk fallback
  const originalGoogleScriptRun = window.google?.script?.run;
  
  // Override jika tidak ada google.script.run (saat di hosting eksternal)
  if (!window.google || !window.google.script) {
    window.google = window.google || {};
    window.google.script = window.google.script || {};
    window.google.script.run = {
      withSuccessHandler: function(callback) {
        this.successCallback = callback;
        return this;
      },
      withFailureHandler: function(callback) {
        this.failureCallback = callback;
        return this;
      },
      // Tambahkan semua fungsi yang dipanggil dari GAS
      submitAbsen: function(nip, deviceId, jenis, lat, lon) {
        return callGoogleScriptGet('submitAbsen', {
          nip: nip,
          deviceId: deviceId,
          jenisApel: jenis,
          latUser: lat,
          lonUser: lon
        })
        .then(this.successCallback)
        .catch(this.failureCallback);
      },
      
      checkDuplicateRegistration: function(nip, deviceId) {
        return callGoogleScriptGet('checkDuplicateRegistration', {
          nip: nip,
          deviceId: deviceId
        })
        .then(this.successCallback)
        .catch(this.failureCallback);
      },
      
      signupUser: function(nip, deviceId) {
        return callGoogleScriptGet('signupUser', {
          nip: nip,
          deviceId: deviceId
        })
        .then(this.successCallback)
        .catch(this.failureCallback);
      },
      
      checkRegistrationStatus: function(deviceId) {
        return callGoogleScriptGet('checkRegistrationStatus', {
          deviceId: deviceId
        })
        .then(this.successCallback)
        .catch(this.failureCallback);
      },
      
      cekStatusAbsensiHariIni: function(nip) {
        return callGoogleScriptGet('cekStatusAbsensiHariIni', {
          nip: nip
        })
        .then(this.successCallback)
        .catch(this.failureCallback);
      },
      
      getRiwayatAbsensi: function(nip, limit) {
        return callGoogleScriptGet('getRiwayatAbsensi', {
          nip: nip,
          limit: limit || 10
        })
        .then(this.successCallback)
        .catch(this.failureCallback);
      },
      
      // Tambahkan fungsi lain yang digunakan
      getUserDataByDeviceId: function(deviceId) {
        return callGoogleScriptGet('getUserDataByDeviceId', {
          deviceId: deviceId
        })
        .then(this.successCallback)
        .catch(this.failureCallback);
      }
    };
  }
</script>
</body>
</html>
